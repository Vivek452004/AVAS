<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <meta name="color-scheme" content="dark"/>
  <title>Avas - AI-Powered Nationwide Plot Search</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/@phosphor-icons/web"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  
  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet"/>

  <style>
    :root {
      --brand-primary: #6366f1; /* Indigo 500 */
      --brand-secondary: #f59e0b; /* Amber 500 */
      --bg-dark: #05070D;
      --text-light: #e2e8f0; /* Slate 200 */
      --text-muted: #94a3b8; /* Slate 400 */
      --card-dark: #0b1220;
      --card-elevated: #0f172a; /* Slate 900 */
      --border-dark: #1e293b; /* Slate 800 */
      --brand-glow: rgba(99, 102, 241, 0.5);
    }
    html { scroll-behavior: smooth; }
    body { font-family: 'Inter', system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; background-color: var(--bg-dark); color: var(--text-light); -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }
    ::-webkit-scrollbar { width: 8px; }
    ::-webkit-scrollbar-track { background: var(--bg-dark); }
    ::-webkit-scrollbar-thumb { background: var(--border-dark); border-radius: 4px; }
    ::-webkit-scrollbar-thumb:hover { background: var(--text-muted); }
    header { background-color: rgba(5, 7, 13, 0.7); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); border-bottom: 1px solid transparent; }
    header.scrolled { box-shadow: 0 6px 30px rgba(0, 0, 0, 0.35); border-bottom: 1px solid var(--border-dark); }
    .hero-section { padding-top: 8rem; padding-bottom: 8rem; background: linear-gradient(180deg, var(--card-elevated) 0%, var(--bg-dark) 100%); }
    .text-gradient { background-image: linear-gradient(to right, #a5b4fc, #818cf8); -webkit-background-clip: text; background-clip: text; color: transparent; }
    .hero-search-container { background: rgba(15, 23, 42, 0.5); backdrop-filter: blur(8px); border: 1px solid var(--border-dark); box-shadow: 0 20px 40px rgba(0,0,0,0.3); }
    .hero-search-tab.active { color: white; border-color: var(--brand-primary); }
    .hero-search-input { background-color: transparent; border: none; color: white; }
    .hero-search-input:focus { outline: none; box-shadow: none; }
    .plot-card { background-color: var(--card-dark); border-radius: 0.75rem; overflow: hidden; border: 1px solid var(--border-dark); transition: transform 0.3s ease, box-shadow 0.3s ease; }
    .plot-card:hover { transform: translateY(-8px); box-shadow: 0 0 35px rgba(99, 102, 241, 0.2); }
    .plot-card-image-wrapper { position: relative; aspect-ratio: 16 / 10; cursor: pointer; }
    .plot-card-image { width: 100%; height: 100%; object-fit: cover; transition: transform .3s ease; }
    .plot-card:hover .plot-card-image { transform: scale(1.05); }
    .checkbox-icon { transition: all .2s ease; border: 2px solid var(--text-muted); }
    .checkbox-icon .ph-check { transform: scale(0.5); opacity: 0; transition: all .2s ease-in-out; }
    .select-plot-checkbox:checked + .checkbox-icon { background-color: var(--brand-primary); border-color: var(--brand-primary); }
    .select-plot-checkbox:checked + .checkbox-icon .ph-check { transform: scale(1); opacity: 1; }
    .modal { transition: opacity .25s ease; }
    .modal-content { background-color: var(--card-dark); transition: transform .25s ease, opacity .25s ease; }
    .loader { border: 4px solid var(--border-dark); border-radius: 50%; border-top: 4px solid var(--brand-primary); width: 40px; height: 40px; animation: spin 1s linear infinite; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    .form-input { width: 100%; padding: .75rem 1rem; background-color: var(--card-elevated); border: 1px solid var(--border-dark); color: var(--text-light); border-radius: .5rem; transition: border-color .15s ease, box-shadow .15s ease; }
    .form-input:focus { outline: none; border-color: var(--brand-primary); box-shadow: 0 0 0 3px var(--brand-glow); }
    .city-filter-btn { transition: all .2s ease; }
    .city-filter-btn.active { background-color: var(--brand-primary) !important; color: white !important; box-shadow: 0 8px 24px rgba(99, 102, 241, 0.35); }
    button:disabled { opacity: .5; cursor: not-allowed; }
    .nav-link.active { color: #a5b4fc; font-weight: 700; }
    @keyframes fade-in-up { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    .animate-on-scroll { opacity: 0; transform: translateY(20px); transition: opacity 0.6s ease-out, transform 0.6s ease-out; }
    .animate-on-scroll.in-view { opacity: 1; transform: translateY(0); }
    .feature-card { background-color: var(--card-elevated); border: 1px solid var(--border-dark); padding: 2rem; border-radius: 1rem; text-align: center; transition: all .3s ease; }
    .feature-card:hover { transform: translateY(-5px); border-color: var(--brand-primary); box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
    .feature-icon { width: 4rem; height: 4rem; margin: 0 auto; border-radius: 9999px; display: flex; align-items: center; justify-content: center; font-size: 2rem; }
    @keyframes pulse { 50% { box-shadow: 0 0 0 4px rgba(99, 102, 241, 0); } }
    .step-circle { transition: all 0.3s ease; }
    .step.active .step-circle { border-color: var(--brand-primary); background-color: var(--brand-primary); color: white; animation: pulse 2s infinite; box-shadow: 0 0 0 0 rgba(99, 102, 241, 0.7); }
    .step-label { font-size: 0.875rem; margin-top: 0.5rem; transition: color 0.3s ease; color: #6b7280; }
    .step.active .step-label { color: white; font-weight: 600; }
    .step.completed .step-circle { border-color: #16a34a; background-color: #16a34a; color: white; }
    .step.completed .step-label { color: var(--text-light); }
    .step:not(:last-child)::after { content: ''; position: absolute; top: 1.25rem; left: 50%; width: 100%; height: 2px; background-color: var(--border-dark); transform: translateY(-50%); z-index: 0; transition: background-color .4s ease; }
    .step.completed::after { background-color: #16a34a; }
    .drop-area { border: 2px dashed var(--border-dark); padding: 2.5rem 1rem; text-align: center; cursor: pointer; border-radius: 0.75rem; transition: all 0.2s ease; }
    .drop-area.dragover { border-color: var(--brand-primary); background-color: rgba(99, 102, 241, 0.1); }
    .drop-area-sm { border: 2px solid var(--border-dark); padding: 1rem; cursor: pointer; border-radius: 0.75rem; transition: all 0.2s ease; }
    .drop-area-sm:hover { border-color: var(--brand-primary); }
    .drop-area-sm.dragover { border-color: var(--brand-primary); background-color: rgba(99, 102, 241, 0.1); }
    .preview-image-container { position: relative; width: 100%; padding-top: 100%; }
    .preview-image { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; border-radius: 0.5rem; }
    .remove-image-btn { position: absolute; top: -0.5rem; right: -0.5rem; background-color: rgba(255, 0, 0, 0.8); color: white; border-radius: 9999px; width: 1.5rem; height: 1.5rem; display: flex; align-items: center; justify-content: center; font-size: 1rem; cursor: pointer; border: 2px solid var(--bg-dark); }
    .gradient-btn { background-image: linear-gradient(to right, #4f46e5, #6366f1, #818cf8); transition: all 0.2s ease; background-size: 200% auto; }
    .gradient-btn:hover { box-shadow: 0 10px 20px -10px rgba(99, 102, 241, 0.6); background-position: right center; }
    .chat-bubble-user { background-color: var(--brand-primary); }
    .chat-bubble-ai { background-color: var(--card-elevated); }
    .chat-bubble-ai p { margin: 0; }
    .chat-bubble-ai strong { color: var(--text-light); }
    .chat-bubble-ai ul { padding-left: 1.25rem; margin-top: 0.5rem; margin-bottom: 0; }
    .chat-bubble-ai li { margin-bottom: 0.25rem; }
    .category-card { position: relative; border-radius: 0.75rem; overflow: hidden; aspect-ratio: 4 / 3; transition: transform 0.3s ease, box-shadow 0.3s ease; }
    .category-card:hover { transform: translateY(-5px); box-shadow: 0 15px 30px rgba(0,0,0,0.3); }
    .category-card img { width: 100%; height: 100%; object-fit: cover; transition: transform 0.3s ease; }
    .category-card:hover img { transform: scale(1.05); }
    .category-card-overlay { position: absolute; inset: 0; background: linear-gradient(to top, rgba(0,0,0,0.8) 20%, transparent 60%); display: flex; flex-direction: column; justify-content: flex-end; padding: 1rem; }
    .category-count { position: absolute; top: 1rem; right: 1rem; background-color: rgba(0,0,0,0.5); backdrop-filter: blur(5px); color: white; font-size: 0.75rem; font-weight: 600; padding: 0.25rem 0.6rem; border-radius: 9999px; }
    @keyframes shimmer { 0% { background-position: -1000px 0; } 100% { background-position: 1000px 0; } }
    .shimmer { background: linear-gradient(to right, transparent 0%, #1e293b 50%, transparent 100%); background-size: 2000px 100%; animation: shimmer 2s linear infinite; }
    .plan-card.popular { border-color: var(--brand-primary); box-shadow: 0 0 25px rgba(99, 102, 241, 0.3); }
    .form-input-icon { position: absolute; top: 50%; left: 1rem; transform: translateY(-50%); color: var(--text-muted); }
    .ad-type-card { display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 1.5rem 1rem; border: 2px solid var(--border-dark); border-radius: 0.75rem; cursor: pointer; transition: all 0.2s ease-in-out; text-align: center; }
    .ad-type-card:hover { border-color: var(--brand-primary); background-color: rgba(99, 102, 241, 0.1); }
    input[name="ad_type"]:checked + span { border-color: var(--brand-primary); box-shadow: 0 0 15px var(--brand-glow); background-color: rgba(99, 102, 241, 0.1); }
    .submit-button-gradient { width: 100%; padding: 0.8rem 1rem; font-weight: 600; color: white; border-radius: 0.5rem; display: flex; align-items: center; justify-content: center; gap: 0.5rem; background-image: linear-gradient(to right, #4f46e5, #6366f1, #818cf8); transition: all 0.3s ease; background-size: 200% auto; border: none; }
    .submit-button-gradient:hover { box-shadow: 0 10px 20px -10px rgba(99, 102, 241, 0.6); background-position: right center; }
    .form-label { display: block; font-weight: 600; color: var(--text-light); margin-bottom: 0.5rem; }
    .pac-container { background-color: var(--card-elevated); border: 1px solid var(--border-dark); border-radius: 0.5rem; box-shadow: 0 10px 30px rgba(0,0,0,0.3); z-index: 9999 !important; }
    .pac-item { padding: 0.75rem; cursor: pointer; color: var(--text-light); border: none; }
    .pac-item:hover { background-color: var(--brand-primary); }
    .pac-item-query { font-weight: 600; }
    .pac-icon { display: none; }
    .role-card { padding: 1rem; border: 2px solid var(--border-dark); border-radius: 0.5rem; text-align: center; cursor: pointer; transition: all 0.2s ease-in-out; }
    .role-card:hover { border-color: var(--brand-primary); background-color: rgba(99, 102, 241, 0.1); }
    .role-card input:checked ~ span { color: var(--brand-primary); font-weight: 600; }
    .role-card:has(input:checked) { border-color: var(--brand-primary); box-shadow: 0 0 15px var(--brand-glow); background-color: rgba(99, 102, 241, 0.1); }
    .lifestyle-tag { background-color: var(--card-elevated); border: 1px solid var(--border-dark); color: var(--text-muted); padding: 0.75rem 1rem; border-radius: 9999px; font-weight: 500; cursor: pointer; transition: all 0.2s ease-in-out; display: flex; align-items: center; justify-content: center; gap: 0.5rem; }
    .lifestyle-tag:hover { border-color: var(--brand-primary); color: white; }
    .lifestyle-tag input:checked + span { color: white; }
    .lifestyle-tag:has(input:checked) { background-color: var(--brand-primary); border-color: var(--brand-primary); color: white; box-shadow: 0 0 15px var(--brand-glow); }
  </style>
</head>
<body class="antialiased">

  <header class="fixed top-0 left-0 right-0 z-40 transition-all duration-300">
    <nav class="container mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex items-center justify-between h-20">
        <div class="flex-shrink-0 flex items-center space-x-3">
          <i class="ph-bold ph-map-trifold text-4xl text-white"></i>
          <a href="#" class="text-3xl font-extrabold text-white">Avas</a>
        </div>
        <div class="hidden md:flex items-center justify-center flex-1 space-x-10 text-lg font-semibold">
          <a href="#plots" id="plots-nav-link" class="nav-link text-white hover:text-indigo-300">Plots</a>
          <a href="#plots" id="land-nav-link" class="nav-link text-white hover:text-indigo-300">Land</a>
          <a href="#" id="advertise-btn" class="text-white hover:text-indigo-300 cursor-pointer">Advertise</a>
          <a href="#" id="subscription-btn" class="text-white hover:text-indigo-300 cursor-pointer">Subscription</a>
        </div>
        <div class="flex items-center space-x-2">
          <button id="add-plot-btn" class="px-4 py-2 text-sm font-semibold bg-green-600 text-white rounded-md hover:bg-green-700 transition-colors flex items-center gap-2">
            <i class="ph-bold ph-plus-circle"></i> Add Plot
          </button>
          <div id="auth-container">
            <button id="login-btn" class="sm:inline-flex items-center justify-center px-5 py-2.5 border border-transparent text-base font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700">
              Login
            </button>
          </div>
          <div id="user-profile" class="hidden items-center space-x-2"></div>
          <button id="settings-btn" class="p-2.5 rounded-md text-slate-300 hover:bg-slate-800 hover:text-white transition-colors">
            <i class="ph-bold ph-gear text-2xl"></i>
          </button>
        </div>
      </div>
    </nav>
  </header>

  <main>
    <section class="hero-section">
      <div class="container mx-auto px-4 sm:px-6 lg:px-8 text-center flex flex-col items-center">
        <h1 class="text-4xl md:text-6xl font-extrabold leading-tight text-white animate-on-scroll in-view">
            The Smartest Way to <span class="text-gradient">Find Your Land</span>
        </h1>
        <p class="mt-6 text-lg md:text-xl text-slate-300 max-w-2xl mx-auto animate-on-scroll in-view" style="animation-delay: 200ms;">Avas uses AI to analyze thousands of listings, helping you find the perfect plot for your future.</p>
        <div class="hero-search-container mt-10 w-full max-w-4xl rounded-full p-2 animate-on-scroll in-view" style="animation-delay: 400ms;">
          <div class="flex items-center">
            <div id="search-tabs" class="flex items-center pl-4 pr-2">
                <button class="hero-search-tab whitespace-nowrap py-2 px-4 text-sm sm:text-base font-semibold text-slate-300 border-b-2 border-transparent transition-all duration-200 active" data-search-type="location">Location</button>
                <button class="hero-search-tab whitespace-nowrap py-2 px-4 text-sm sm:text-base font-semibold text-slate-300 border-b-2 border-transparent transition-all duration-200" data-search-type="lifestyle">Lifestyle</button>
            </div>
             <form id="city-search-form" class="flex-grow flex items-center">
                <div class="relative flex-grow">
                  <i class="ph-bold ph-map-pin absolute top-1/2 left-4 -translate-y-1/2 text-slate-400 text-xl"></i>
                  <input type="text" id="city-search-input" placeholder="Search by City, Location, or Zip..." class="w-full pl-12 pr-4 py-4 hero-search-input placeholder-slate-400 focus:ring-0 text-lg">
                </div>
                <button type="submit" class="p-3.5 rounded-full font-semibold bg-indigo-600 text-white hover:bg-indigo-700 transition-colors">
                  <i class="ph-bold ph-magnifying-glass text-2xl"></i>
                </button>
              </form>
          </div>
        </div>
         <div id="lifestyle-search-container" class="hidden mt-4 w-full max-w-4xl mx-auto">
            <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                <label class="lifestyle-tag"><input type="checkbox" value="Family Friendly" class="sr-only"><span><i class="ph-bold ph-baby"></i> Family Friendly</span></label>
                <label class="lifestyle-tag"><input type="checkbox" value="IT Hub Access" class="sr-only"><span><i class="ph-bold ph-desktop-tower"></i> IT Hub Access</span></label>
                <label class="lifestyle-tag"><input type="checkbox" value="Peaceful & Quiet" class="sr-only"><span><i class="ph-bold ph-leaf"></i> Peaceful & Quiet</span></label>
                <label class="lifestyle-tag"><input type="checkbox" value="High Investment Potential" class="sr-only"><span><i class="ph-bold ph-chart-line-up"></i> Investment Hub</span></label>
            </div>
             <button id="lifestyle-search-btn" class="mt-4 px-8 py-3 bg-indigo-600 text-white font-semibold rounded-full hover:bg-indigo-700 transition-colors flex items-center gap-2 mx-auto">
                <i class="ph-bold ph-magic-wand"></i> Find My Perfect Plot
              </button>
        </div>
      </div>
    </section>

    <section id="features" class="py-20">
        <div class="container mx-auto px-4 sm:px-6 lg:px-8">
            <div class="text-center mb-12">
                <h2 class="text-3xl md:text-4xl font-bold text-white">A Smarter Way to Find Land</h2>
                <p class="mt-4 text-lg text-slate-400 max-w-2xl mx-auto">We leverage technology to give you a competitive edge in the real estate market.</p>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                <div class="feature-card animate-on-scroll">
                    <div class="feature-icon bg-indigo-500/10 text-indigo-400"><i class="ph-bold ph-brain"></i></div>
                    <h3 class="text-xl font-bold mt-4 text-white">AI-Powered Insights</h3>
                    <p class="text-slate-400 mt-2">Get AI-generated summaries, price trend analyses, and Vastu scores to make informed decisions faster.</p>
                </div>
                <div class="feature-card animate-on-scroll" style="animation-delay: 200ms;">
                    <div class="feature-icon bg-green-500/10 text-green-400"><i class="ph-bold ph-shield-check"></i></div>
                    <h3 class="text-xl font-bold mt-4 text-white">Verified Listings</h3>
                    <p class="text-slate-400 mt-2">Browse with confidence. Our AI-assisted document verification helps ensure listings are authentic and trustworthy.</p>
                </div>
                <div class="feature-card animate-on-scroll" style="animation-delay: 400ms;">
                    <div class="feature-icon bg-sky-500/10 text-sky-400"><i class="ph-bold ph-map-trifold"></i></div>
                    <h3 class="text-xl font-bold mt-4 text-white">Seamless Experience</h3>
                    <p class="text-slate-400 mt-2">From an intuitive map-based search to a simple 4-step listing process, Avas is designed for ease of use.</p>
                </div>
            </div>
        </div>
    </section>

    <section id="plots" class="py-16 bg-slate-900/20">
      <div class="container mx-auto px-4 sm:px-6 lg:px-8">
        <h2 id="browse-heading" class="text-3xl font-bold text-white mb-8">Featured Listings in Pune</h2>
        <div id="category-browser" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-12"></div>
        <div id="city-filter" class="flex justify-center flex-wrap gap-3 mb-10"></div>
        <div id="plot-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-8"></div>
      </div>
    </section>
  </main>

  <div class="fixed bottom-6 left-1/2 -translate-x-1/2 z-30 bg-[#111827]/80 backdrop-blur-lg p-2 rounded-full shadow-lg flex items-center space-x-1 border border-slate-700">
    <button id="summarize-btn" class="px-4 py-2 text-sm font-semibold text-slate-200 hover:bg-slate-700 rounded-full flex items-center gap-2" disabled><i class="ph-bold ph-sparkle"></i> Summarize (0)</button>
    <button id="best-value-btn" class="px-4 py-2 text-sm font-semibold text-slate-200 hover:bg-slate-700 rounded-full flex items-center gap-2" disabled><i class="ph-bold ph-tag"></i> Best Value (0)</button>
    <button id="compare-btn" class="px-4 py-2 text-sm font-semibold text-slate-200 hover:bg-slate-700 rounded-full flex items-center gap-2" disabled><i class="ph-bold ph-git-compare"></i> Compare (0/2)</button>
    <div id="feedback-toast" class="text-sm font-semibold absolute -top-12 left-1/2 -translate-x-1/2 w-max px-4 py-2 rounded-md shadow-lg opacity-0 transition-all duration-300"></div>
  </div>

  <div id="modal-wrapper" class="modal fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-70 backdrop-blur-sm opacity-0 pointer-events-none">
    <div class="modal-content rounded-2xl shadow-xl w-11/12 md:max-w-4xl mx-auto transform opacity-0 -translate-y-4">
      <div class="flex justify-between items-center p-4 border-b border-slate-800">
        <h3 id="modal-title" class="text-2xl font-bold"></h3>
        <button id="modal-close-btn" class="text-slate-400 hover:text-white text-3xl">&times;</button>
      </div>
      <div id="modal-body" class="p-6 max-h-[80vh] overflow-y-auto"></div>
    </div>
  </div>

  <template id="plot-card-template">
    <div class="plot-card">
      <div class="plot-card-image-wrapper" onclick="openPlotDetailModal({id})">
        <img src="{image_url}" class="plot-card-image" alt="Plot in {location}" onerror="this.onerror=null;this.src='https://placehold.co/600x400/1e293b/e2e8f0?text=Image+Not+Found'">
        <div class="absolute inset-0 bg-gradient-to-t from-black/50 to-transparent"></div>
        <div class="absolute top-3 left-3 flex gap-2">
          {tags}
        </div>
        <div class="absolute top-3 right-3">
            <label class="flex items-center" onclick="event.stopPropagation()">
                <input type="checkbox" data-id="{id}" class="select-plot-checkbox sr-only">
                <div class="checkbox-icon flex items-center justify-center w-8 h-8 cursor-pointer bg-black/40 backdrop-blur-sm rounded-md text-white hover:bg-black/60">
                    <i class="ph-bold ph-check text-xl"></i>
                </div>
            </label>
        </div>
      </div>
      <div class="p-4">
        <div class="flex justify-between items-center">
          <p class="text-xs font-semibold text-indigo-400">{property_type}</p>
          <button class="ask-ai-btn p-1.5 rounded-md hover:bg-slate-700 text-slate-400 hover:text-indigo-300" data-id="{id}">
            <i class="ph-bold ph-chat-circle-dots text-xl"></i>
          </button>
        </div>
        <p class="text-2xl font-bold text-white mt-1">{price}</p>
        <p class="text-slate-400 mt-2">{area_sqft} sqft • {location}</p>
        <p class="text-slate-500 text-sm">{city}</p>
      </div>
    </div>
  </template>

  <template id="new-login-template">
    <div class="relative w-full h-full flex items-center justify-center p-4" style="background-color: var(--bg-dark);">
        <button id="login-close-btn" class="absolute top-6 right-8 text-slate-200 hover:text-white text-4xl z-20">&times;</button>
        <div class="w-full max-w-lg bg-card-dark rounded-2xl shadow-2xl flex overflow-hidden border border-border-dark z-10">
            <div class="w-full p-8 md:p-12 flex flex-col justify-center">
                <div class="mb-8 text-center">
                    <h2 id="title" class="text-3xl font-bold text-white">Join Avas</h2>
                    <p id="subtitle" class="text-slate-400 mt-2">Sign in or create an account to continue.</p>
                </div>
                <form id="auth-form" class="space-y-4">
                    <button id="google-signin-btn" type="button" class="w-full py-3 bg-white text-slate-800 font-semibold rounded-lg hover:bg-slate-200 transition-colors flex items-center justify-center gap-3">
                        <svg class="w-6 h-6" viewBox="0 0 24 24"><path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" fill="#4285F4"/><path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/><path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" fill="#FBBC05"/><path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/><path d="M1 1h22v22H1z" fill="none"/></svg>
                        Sign In with Google
                    </button>
                     <div class="flex items-center my-4">
                        <hr class="flex-grow border-t border-border-dark">
                        <span class="px-4 text-slate-400 text-sm">OR</span>
                        <hr class="flex-grow border-t border-border-dark">
                    </div>
                     <div id="otp-step" class="space-y-4">
                        <div>
                            <label for="phone" class="font-semibold text-slate-300">Sign In with Mobile Number</label>
                            <div class="relative mt-2">
                                <i class="ph-bold ph-phone form-input-icon"></i>
                                <input type="tel" id="phone" placeholder="+91 XXXXX XXXXX" class="form-input pl-12">
                            </div>
                        </div>
                        <div id="otp-container" class="hidden">
                            <label for="otp" class="font-semibold text-slate-300">Enter OTP</label>
                            <div class="relative mt-2">
                               <i class="ph-bold ph-key form-input-icon"></i>
                               <input type="text" id="otp" placeholder="Enter 6-digit OTP" class="form-input pl-12">
                           </div>
                        </div>
                    </div>
                    
                    <p id="message" class="text-center text-red-400 text-sm h-5"></p>
                    <button id="submitBtn" type="submit" class="w-full py-3 bg-indigo-600 text-white font-semibold rounded-lg hover:bg-indigo-700 transition-colors">Send OTP</button>
                </form>
            </div>
        </div>
    </div>
  </template>

  <template id="role-selection-modal-template">
    <div class="p-4 sm:p-6 text-center">
      <h2 class="text-2xl font-bold text-white">One last step...</h2>
      <p class="text-slate-400 mt-2">To personalize your experience, please tell us who you are.</p>
      <div id="role-selection" class="grid grid-cols-2 gap-4 my-6">
          <label class="role-card"><input type="radio" name="role" value="buyer" class="sr-only" checked><span><i class="ph-bold ph-shopping-cart-simple text-2xl mb-1"></i><br>Buyer/Customer</span></label>
          <label class="role-card"><input type="radio" name="role" value="owner" class="sr-only"><span><i class="ph-bold ph-user text-2xl mb-1"></i><br>Owner</span></label>
          <label class="role-card"><input type="radio" name="role" value="agent" class="sr-only"><span><i class="ph-bold ph-briefcase text-2xl mb-1"></i><br>Agent</span></label>
          <label class="role-card"><input type="radio" name="role" value="builder" class="sr-only"><span><i class="ph-bold ph-buildings text-2xl mb-1"></i><br>Builder</span></label>
      </div>
      <button id="save-role-btn" class="submit-button-gradient">Complete Signup</button>
    </div>
  </template>

  <template id="user-profile-modal-template">
    <div class="space-y-8 p-2">
        <div>
            <h3 class="text-2xl font-bold text-white">My Profile</h3>
            <div class="mt-4 p-6 bg-slate-800/50 rounded-lg border border-slate-700 space-y-4">
                <div class="flex items-center gap-4">
                    <img id="profile-pic" src="" class="w-16 h-16 rounded-full object-cover">
                    <div>
                        <p id="profile-name" class="text-xl font-bold text-white"></p>
                        <p id="profile-contact" class="text-sm text-slate-400"></p>
                        <p id="profile-role" class="text-sm font-semibold uppercase text-indigo-400 tracking-wider mt-1"></p>
                    </div>
                </div>
            </div>
        </div>

        <div id="seller-profile-section" class="hidden">
            <h3 class="text-2xl font-bold text-white">My Listings</h3>
            <div id="my-listings-container" class="mt-4 space-y-4">
                </div>
        </div>

        <div id="buyer-profile-section" class="hidden">
            <h3 class="text-2xl font-bold text-white">My Activity</h3>
            <div id="my-activity-container" class="mt-4 space-y-4">
                 <p class="text-slate-400 text-center py-4">Your saved plots and recent activity will appear here.</p>
            </div>
        </div>
    </div>
  </template>

  <template id="user-listing-card-template">
    <div class="my-listing-card flex items-center gap-4 p-4 bg-slate-800/50 rounded-lg border border-slate-700">
      <img src="{image_url}" class="w-24 h-24 rounded-md object-cover flex-shrink-0">
      <div class="flex-grow">
          <p class="font-bold text-white">{location}</p>
          <p class="text-sm text-slate-400">{city} • {area_sqft} sqft</p>
          <p class="text-lg font-semibold text-indigo-400 mt-1">₹{price}</p>
      </div>
      <div class="flex flex-col gap-2">
          <button class="edit-plot-btn p-2 rounded-md bg-slate-700 hover:bg-slate-600 text-white transition-colors" data-id="{id}"><i class="ph-bold ph-pencil-simple"></i></button>
          <button class="delete-plot-btn p-2 rounded-md bg-red-800/50 hover:bg-red-800/80 text-white transition-colors" data-id="{id}"><i class="ph-bold ph-trash"></i></button>
      </div>
    </div>
  </template>

  <template id="chat-modal-template">
    <div class="flex flex-col h-full">
      <div id="chat-context" class="p-2 border-b border-slate-700 text-xs text-center text-slate-400 hidden flex-shrink-0"></div>
      <div id="chat-box" class="flex-grow p-4 overflow-y-auto space-y-4"></div>
      <div id="chat-starters" class="p-4 border-t border-slate-700 grid grid-cols-2 gap-2 flex-shrink-0"></div>
      <div class="p-4 border-t border-slate-700 flex-shrink-0">
        <div class="relative">
          <input type="text" id="chat-input" class="form-input pr-12" placeholder="Ask about plots, investments...">
          <button id="chat-send-btn" class="absolute top-1/2 right-2 -translate-y-1/2 bg-indigo-600 text-white p-2 rounded-full hover:bg-indigo-700"><i class="ph-fill ph-paper-plane-tilt"></i></button>
        </div>
      </div>
    </div>
  </template>

  <template id="plot-detail-template">
    <div class="p-4 sm:p-8 relative">
      <button id="detail-close-btn" class="fixed top-6 left-8 text-white bg-black/30 backdrop-blur-sm hover:bg-black/50 p-3 rounded-full z-50 transition-colors">
          <i class="ph-bold ph-arrow-left text-2xl"></i>
      </button>
      <div class="grid grid-cols-1 lg:grid-cols-5 gap-8">
          <div class="lg:col-span-3">
              <img id="plot-detail-img" src="" class="w-full h-96 object-cover rounded-lg shadow-lg mb-8" alt="Plot photo">
              <h3 class="text-2xl font-bold flex items-center gap-2 mb-4 text-white"><i class="ph-bold ph-chart-line-up text-indigo-400"></i>AI Price Trends</h3>
              <div class="p-4 bg-slate-800/50 rounded-lg h-64">
                  <canvas id="price-trend-chart"></canvas>
              </div>
          </div>
          <div class="lg:col-span-2">
              <div class="flex items-start justify-between">
                  <div>
                      <h2 id="plot-detail-location" class="text-3xl font-bold text-white"></h2>
                      <p id="plot-detail-city" class="text-slate-400 text-lg"></p>
                  </div>
                  <div id="plot-detail-verified-badge"></div>
              </div>
              <p id="plot-detail-price" class="text-4xl font-bold text-gradient my-6"></p>
              <div class="p-4 rounded-lg bg-slate-800/50 border border-slate-700">
                  <h4 class="font-bold text-lg text-slate-300 flex items-center gap-2"><i class="ph-bold ph-brain text-indigo-400"></i>AI-Generated Summary</h4>
                  <p id="ai-summary" class="text-slate-400 mt-2 text-sm leading-relaxed"></p>
              </div>
              <div class="grid grid-cols-2 gap-4 mt-6">
                  <div class="p-4 rounded-lg bg-green-900/50 border border-green-500/50 text-center">
                      <h4 class="font-semibold text-green-300">AI Price Growth (5 Yrs)</h4>
                      <p id="plot-detail-prediction" class="text-2xl font-bold text-white mt-1"></p>
                  </div>
                  <div class="p-4 rounded-lg bg-yellow-900/50 border border-yellow-500/50 text-center">
                      <h4 class="font-semibold text-yellow-300">AI Vastu Score</h4>
                      <p id="vastu-score" class="text-2xl font-bold text-white mt-1"></p>
                  </div>
              </div>
              <div id="contact-seller-section" class="mt-6"></div>
          </div>
      </div>
      <div class="mt-12">
          <h3 class="text-2xl font-bold flex items-center gap-2 mb-4 text-white"><i class="ph-bold ph-map-pin-line text-indigo-400"></i>What's Nearby</h3>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mt-4">
              <div id="neighborhood-map" class="w-full h-80 rounded-lg border border-slate-700"></div>
              <div id="neighborhood-list" class="space-y-3"></div>
          </div>
      </div>
    </div>
  </template>

  <template id="subscription-modal-template">
    <div class="p-2 sm:p-4">
      <div class="text-center mb-6">
        <h2 class="text-3xl font-bold text-white">Unlock Your Potential</h2>
        <p class="text-slate-400 mt-2">Choose the plan that's right for you and get access to exclusive AI-powered features.</p>
      </div>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        <div class="plan-card">
          <h3 class="text-2xl font-semibold">Free</h3>
          <p class="text-slate-400 text-sm mt-1">For casual browsing</p>
          <p class="text-4xl font-extrabold my-4">₹0</p>
          <ul class="space-y-3 text-slate-300 text-sm flex-grow">
            <li class="flex items-center gap-3"><i class="ph-bold ph-check-circle text-green-500"></i> Basic Plot Search</li>
            <li class="flex items-center gap-3"><i class="ph-bold ph-check-circle text-green-500"></i> Unlimited AI Analyses</li>
            <li class="flex items-center gap-3"><i class="ph-bold ph-x-circle text-red-500"></i> No Ads</li>
            <li class="flex items-center gap-3"><i class="ph-bold ph-x-circle text-red-500"></i> Seller Contact Info</li>
          </ul>
          <button data-plan="free" class="plan-btn mt-6 w-full py-3 bg-slate-700 text-white font-semibold rounded-lg hover:bg-slate-600 transition-colors">Current Plan</button>
        </div>
        <div class="plan-card popular">
          <div class="popular-badge">Most Popular</div>
          <h3 class="text-2xl font-semibold">Enterprise</h3>
          <p class="text-slate-400 text-sm mt-1">For serious buyers & agents</p>
          <p class="text-4xl font-extrabold my-4">₹399 <span class="text-lg font-medium text-slate-400">/mo</span></p>
          <ul class="space-y-3 text-slate-300 text-sm flex-grow">
            <li class="flex items-center gap-3"><i class="ph-bold ph-check-circle text-green-500"></i> Advanced AI Search</li>
            <li class="flex items-center gap-3"><i class="ph-bold ph-check-circle text-green-500"></i> Unlimited AI Analyses</li>
            <li class="flex items-center gap-3"><i class="ph-bold ph-check-circle text-green-500"></i> Ad-Free Experience</li>
            <li class="flex items-center gap-3"><i class="ph-bold ph-check-circle text-green-500"></i> Seller Contact Info</li>
            <li class="flex items-center gap-3"><i class="ph-bold ph-check-circle text-green-500"></i> Priority Support</li>
          </ul>
          <button data-plan="enterprise" data-amount="399" class="plan-btn mt-6 w-full py-3 bg-indigo-600 text-white font-semibold rounded-lg hover:bg-indigo-700 transition-colors">Choose Enterprise</button>
        </div>
        <div class="plan-card">
          <h3 class="text-2xl font-bold">Pro</h3>
          <p class="text-slate-400 text-sm mt-1">For builders & businesses</p>
          <p class="text-4xl font-extrabold my-4">₹999 <span class="text-lg font-medium text-slate-400">/mo</span></p>
          <ul class="space-y-3 text-slate-300 text-sm flex-grow">
            <li class="flex items-center gap-3"><i class="ph-bold ph-check-circle text-green-500"></i> All Enterprise Features</li>
            <li class="flex items-center gap-3"><i class="ph-bold ph-check-circle text-green-500"></i> Unlimited AI Analyses</li>
            <li class="flex items-center gap-3"><i class="ph-bold ph-check-circle text-green-500"></i> Advanced Listing Analytics</li>
            <li class="flex items-center gap-3"><i class="ph-bold ph-check-circle text-green-500"></i> API Access</li>
          </ul>
          <button data-plan="pro" data-amount="999" class="plan-btn mt-6 w-full py-3 bg-slate-700 text-white font-semibold rounded-lg hover:bg-slate-600 transition-colors">Choose Pro</button>
        </div>
      </div>
    </div>
  </template>

  <template id="qr-code-modal-template">
    <div class="p-4 sm:p-6 text-center">
      <i class="ph-bold ph-qr-code text-6xl text-indigo-400"></i>
      <h2 class="text-2xl font-bold text-white mt-4">Scan to Pay for {planName}</h2>
      <p class="text-slate-400 mt-2">Amount: <span class="font-bold text-white">₹{amount}</span></p>
      <div class="flex justify-center my-6">
          <img id="qr-code-enterprise" src="QR-Code399.jpg" alt="UPI QR Code for Enterprise Plan" class="rounded-lg border-4 border-white hidden">
          <img id="qr-code-pro" src="QR-Code999.jpg" alt="UPI QR Code for Pro Plan" class="rounded-lg border-4 border-white hidden">
      </div>
      <div class="text-left max-w-sm mx-auto">
           <p class="text-slate-300 text-sm mb-4 text-center">After payment, enter the UPI Transaction ID below to verify.</p>
        <label for="transaction-id" class="form-label">UPI Transaction ID</label>
        <input type="text" id="transaction-id" class="form-input" placeholder="Enter 12-digit ID" required>
        <button id="verify-payment-btn" class="submit-button-gradient mt-4">
            Verify Payment
        </button>
      </div>
    </div>
  </template>

  <template id="advertise-modal-template">
    <div class="p-2 sm:p-4">
      <div class="text-center mb-8">
        <i class="ph-bold ph-rocket-launch text-5xl text-indigo-400"></i>
        <h2 class="text-3xl font-bold text-white mt-2">Reach Your Target Audience</h2>
        <p class="text-slate-400 mt-2 max-w-2xl mx-auto">Promote your listings on Avas to connect with thousands of serious buyers, agents, and investors across the nation.</p>
      </div>
      <form id="adv-form" class="max-w-2xl mx-auto space-y-8">
        <div>
            <label class="block text-lg font-semibold text-white mb-4 text-center sm:text-left">1. Select Ad Type</label>
            <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
              <label class="ad-type-card">
                <input type="radio" name="ad_type" value="featured" class="sr-only" checked>
                <span><i class="ph-bold ph-star text-3xl text-amber-400"></i>
                <span class="font-semibold text-white">Featured Plot</span>
                <p class="text-xs text-slate-400">Top of search results</p></span>
              </label>
              <label class="ad-type-card">
                <input type="radio" name="ad_type" value="banner" class="sr-only">
                <span><i class="ph-bold ph-image text-3xl text-cyan-400"></i>
                <span class="font-semibold text-white">Homepage Banner</span>
                <p class="text-xs text-slate-400">Maximum visibility</p></span>
              </label>
              <label class="ad-type-card">
                <input type="radio" name="ad_type" value="social" class="sr-only">
                <span><i class="ph-bold ph-share-network text-3xl text-pink-400"></i>
                <span class="font-semibold text-white">Social Promotion</span>
                <p class="text-xs text-slate-400">Reach a wider audience</p></span>
              </label>
            </div>
        </div>
        <div>
            <label class="block text-lg font-semibold text-white mb-4 text-center sm:text-left">2. Contact Information</label>
            <div class="p-6 bg-slate-800/50 rounded-lg border border-slate-700 space-y-5">
              <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-5">
                  <div>
                      <label for="contact_name" class="form-label">Your Full Name</label>
                      <input type="text" id="contact_name" name="contact_name" class="form-input" placeholder="e.g., Jane Doe" required>
                  </div>
                  <div>
                      <label for="contact_email" class="form-label">Email Address</label>
                      <div class="relative">
                        <i class="ph-bold ph-envelope absolute top-1/2 left-4 -translate-y-1/2 text-slate-400"></i>
                        <input type="email" id="contact_email" name="contact_email" class="form-input pl-12" placeholder="e.g., jane.doe@example.com" required>
                      </div>
                  </div>
              </div>
              <div>
                  <label for="description" class="form-label">Describe Your Needs</label>
                  <textarea id="description" name="description" rows="4" class="form-input" placeholder="Briefly describe your property, advertising goals..."></textarea>
              </div>
            </div>
        </div>
        <div>
            <button type="submit" class="submit-button-gradient">
              <i class="ph-bold ph-paper-plane-tilt"></i>
              Submit Inquiry
            </button>
        </div>
      </form>
    </div>
  </template>

  <template id="add-plot-template">
    <div id="step-indicator" class="flex justify-between items-start w-full max-w-lg mx-auto mb-8 px-2"></div>
    <form id="add-plot-form" class="px-2">
      <div class="form-step" data-step="1">
        <div class="text-center mb-8">
            <h3 class="text-2xl font-bold text-white">List a New Property</h3>
            <p class="text-slate-400">Step 1: Provide Basic Details</p>
        </div>
        <div class="space-y-5 max-w-lg mx-auto">
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-x-6 gap-y-5">
            <div>
              <label for="property_type" class="form-label">Type of Plot</label>
              <select id="property_type" name="property_type" class="form-input" required><option value="">Select Type</option><option>Residential</option><option>Commercial</option><option>Agricultural</option></select>
            </div>
            <div>
              <label for="location" class="form-label">Location Name</label>
              <input type="text" id="location" name="location" class="form-input" placeholder="e.g., Hinjawadi" required>
            </div>
          </div>
          <div>
            <label for="nearby" class="form-label">Nearby Landmark</label>
            <input type="text" id="nearby" name="nearby" class="form-input" placeholder="e.g., Near Wipro Circle">
          </div>
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-x-6 gap-y-5">
            <div>
              <label for="area_sqft" class="form-label">Area</label>
              <div class="relative">
                <i class="ph-bold ph-arrows-out-simple absolute top-1/2 left-4 -translate-y-1/2 text-slate-400"></i>
                <input type="number" id="area_sqft" name="area_sqft" class="form-input pl-12" placeholder="in Sq.Ft." required>
              </div>
            </div>
            <div>
              <label for="price" class="form-label">Price</label>
              <div class="relative">
                   <span class="absolute top-1/2 left-4 -translate-y-1/2 text-slate-400 font-bold">₹</span>
                <input type="text" id="price" name="price" class="form-input pl-9" placeholder="e.g., 75 Lakhs" required>
              </div>
            </div>
          </div>
           <div id="ai-optimizer-suggestion" class="hidden p-4 bg-indigo-900/30 border border-indigo-700 rounded-lg">
                <h4 class="font-bold text-lg text-indigo-300 flex items-center gap-2"><i class="ph-bold ph-magic-wand"></i>AI Listing Optimizer</h4>
                <p class="text-sm text-slate-400 mt-2"></p>
           </div>
        </div>
        <div class="max-w-lg mx-auto">
            <button type="button" class="w-full mt-8 py-3 bg-indigo-600 text-white font-semibold rounded-lg hover:bg-indigo-700 next-btn" data-next="2">Next: Set Location →</button>
        </div>
      </div>

      <div class="form-step hidden" data-step="2">
        <div class="text-center mb-6">
            <h3 class="text-2xl font-bold text-white">Step 2: Pin Location on Map</h3>
            <p class="text-slate-400 text-sm">Search for a location or drag the pin to be exact.</p>
        </div>
        <div class="relative max-w-lg mx-auto mb-4">
            <i class="ph-bold ph-magnifying-glass absolute top-1/2 left-4 -translate-y-1/2 text-slate-400"></i>
            <input type="text" id="location-search-input" class="form-input pl-12" placeholder="Search for a street or landmark...">
        </div>
        <div id="map" class="w-full h-80 rounded-lg border border-slate-700 my-6"></div>
        <div class="flex gap-4 max-w-lg mx-auto">
          <button type="button" class="w-full py-3 bg-slate-700 text-white font-semibold rounded-lg hover:bg-slate-600 prev-btn" data-prev="1">← Previous</button>
          <button type="button" class="w-full py-3 bg-indigo-600 text-white font-semibold rounded-lg hover:bg-indigo-700 next-btn" data-next="3">Next: Upload Images →</button>
        </div>
      </div>

      <div class="form-step hidden" data-step="3">
         <div class="text-center mb-6">
            <h3 class="text-2xl font-bold text-white">Step 3: Upload Plot Images</h3>
            <p class="text-slate-400 text-sm">Add up to 5 images of your property.</p>
        </div>
        <div id="image-drop-area" class="drop-area">
          <i class="ph-bold ph-images text-4xl text-indigo-400"></i>
          <p class="mt-2 text-slate-400">Drag & drop images here, or <span class="text-indigo-400 font-semibold">click to browse</span></p>
          <input type="file" id="image-input" accept="image/*" class="hidden" multiple>
        </div>
        <div id="image-preview-area" class="grid grid-cols-3 sm:grid-cols-5 gap-4 mt-4 min-h-[80px]"></div>
        <div class="flex gap-4 mt-6 max-w-lg mx-auto">
          <button type="button" class="w-full py-3 bg-slate-700 text-white font-semibold rounded-lg hover:bg-slate-600 prev-btn" data-prev="2">← Previous</button>
          <button type="button" class="w-full py-3 bg-indigo-600 text-white font-semibold rounded-lg hover:bg-indigo-700 next-btn" data-next="4">Next: Verification →</button>
        </div>
      </div>

      <div class="form-step hidden" data-step="4">
        <div class="text-center mb-6">
            <h3 class="text-2xl font-bold text-white">Step 4: AI Document Verification</h3>
            <p class="text-sm text-slate-400">Upload documents to get a "Verified" badge and build trust.</p>
        </div>
        <div class="space-y-4 max-w-lg mx-auto">
           <div id="aadhaar-drop-area" class="drop-area-sm">
             <div class="flex items-center gap-3"><i class="ph-bold ph-identification-card text-3xl text-indigo-400"></i>
             <div><p class="font-semibold text-white">Upload Aadhaar Card</p><p id="aadhaar-file-name" class="text-xs text-slate-400">Drag & drop or click</p></div></div>
             <input type="file" id="aadhaar-input" class="hidden" accept="image/*,application/pdf">
           </div>
           <div id="sev-twelve-drop-area" class="drop-area-sm">
             <div class="flex items-center gap-3"><i class="ph-bold ph-file-text text-3xl text-indigo-400"></i>
             <div><p class="font-semibold text-white">Upload 7/12 Extract</p><p id="sev-twelve-file-name" class="text-xs text-slate-400">Drag & drop or click</p></div></div>
             <input type="file" id="sev-twelve-input" class="hidden" accept="image/*,application/pdf">
           </div>
        </div>
        <div id="ai-verification-status" class="mt-4 text-center h-6"></div>
        <div class="flex gap-4 mt-6 max-w-lg mx-auto">
          <button type="button" class="w-full py-3 bg-slate-700 text-white font-semibold rounded-lg hover:bg-slate-600 prev-btn" data-prev="3">← Previous</button>
          <button type="submit" class="w-full py-3 bg-green-600 text-white font-semibold rounded-lg hover:bg-green-700 flex items-center justify-center gap-2">
            <span id="submit-text">Verify with AI & Submit</span>
            <div id="submit-loader" class="w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin hidden"></div>
          </button>
        </div>
      </div>
    </form>
  </template>

  <template id="settings-modal-template">
    <div class="space-y-6">
      <div>
          <h3 class="text-lg font-semibold text-white">API Keys</h3>
          <p class="text-slate-400 text-sm mt-1">Enter your API keys to enable app functionalities.</p>
      </div>
      <form id="api-key-form" class="space-y-4">
          <div>
              <label for="gemini-api-key" class="form-label">Gemini API Key</label>
              <div class="relative">
                  <input type="password" id="gemini-api-key" placeholder="Enter your Gemini API Key" class="form-input pr-10">
                  <button type="button" class="toggle-vis absolute top-1/2 right-3 -translate-y-1/2 text-slate-400 hover:text-white"><i class="ph-bold ph-eye"></i></button>
              </div>
          </div>
          <div>
              <label for="google-maps-api-key" class="form-label">Google Maps API Key</label>
              <div class="relative">
                  <input type="password" id="google-maps-api-key" placeholder="Enter your Google Maps API Key" class="form-input pr-10">
                   <button type="button" class="toggle-vis absolute top-1/2 right-3 -translate-y-1/2 text-slate-400 hover:text-white"><i class="ph-bold ph-eye"></i></button>
              </div>
          </div>
          <div class="flex justify-end pt-2">
              <button type="submit" class="gradient-btn px-6 py-2 font-semibold text-white rounded-md">
                  Save Keys
              </button>
          </div>
      </form>
    </div>
  </template>

  <template id="ai-analysis-loading-template">
    <div class="p-4 sm:p-8 relative min-h-[50vh] flex flex-col items-center justify-center">
      <button onclick="closeModal()" class="fixed top-6 left-8 text-white bg-black/30 backdrop-blur-sm hover:bg-black/50 p-3 rounded-full z-50 transition-colors">
          <i class="ph-bold ph-arrow-left text-2xl"></i>
      </button>
      <div class="flex items-center gap-4 text-2xl font-semibold text-white">
          <i class="ph-bold ph-brain text-4xl text-indigo-400 animate-pulse"></i>
          <span>AI is Analyzing...</span>
      </div>
      <p class="text-slate-400 mt-2">This may take a few moments.</p>
      <div class="w-full max-w-md mt-8 space-y-4">
          <div class="h-8 w-3/4 bg-slate-800 rounded shimmer mx-auto"></div>
          <div class="h-4 w-full bg-slate-800 rounded shimmer"></div>
          <div class="h-4 w-5/6 bg-slate-800 rounded shimmer"></div>
          <div class="h-4 w-full bg-slate-800 rounded shimmer"></div>
      </div>
    </div>
  </template>

  <template id="ai-comparison-template">
     <div class="p-4 sm:p-8 relative">
      <button onclick="closeModal()" class="fixed top-6 left-8 text-white bg-black/30 backdrop-blur-sm hover:bg-black/50 p-3 rounded-full z-50 transition-colors">
          <i class="ph-bold ph-arrow-left text-2xl"></i>
      </button>
      <div class="text-center mb-8">
          <h2 class="text-3xl font-bold text-white">AI Plot Comparison</h2>
          <p class="text-slate-400 mt-2">Here's a side-by-side analysis of the selected properties.</p>
      </div>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-8" id="comparison-columns">
         </div>
      <div class="bg-card-elevated p-6 rounded-lg border border-border-dark">
          <h3 class="text-xl font-bold text-white flex items-center gap-2"><i class="ph-bold ph-sparkle text-amber-400"></i>AI Recommendation</h3>
          <div class="text-slate-300 mt-2 prose prose-invert max-w-none" id="ai-recommendation"></div>
      </div>
     </div>
  </template>

  <template id="ai-summary-template">
     <div class="p-4 sm:p-8 relative">
      <button onclick="closeModal()" class="fixed top-6 left-8 text-white bg-black/30 backdrop-blur-sm hover:bg-black/50 p-3 rounded-full z-50 transition-colors">
          <i class="ph-bold ph-arrow-left text-2xl"></i>
      </button>
      <div class="text-center mb-8">
          <h2 class="text-3xl font-bold text-white">AI Summary</h2>
          <p class="text-slate-400 mt-2" id="summary-location"></p>
      </div>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8 text-center" id="summary-highlights">
         </div>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-8">
          <div id="summary-pros">
              <h3 class="text-xl font-bold text-white flex items-center gap-2 mb-3"><i class="ph-bold ph-check-circle text-green-400"></i>Pros</h3>
              <ul class="space-y-2"></ul>
          </div>
          <div id="summary-cons">
               <h3 class="text-xl font-bold text-white flex items-center gap-2 mb-3"><i class="ph-bold ph-x-circle text-red-400"></i>Cons</h3>
              <ul class="space-y-2"></ul>
          </div>
      </div>
      <div class="bg-card-elevated p-6 rounded-lg border border-border-dark">
          <h3 class="text-xl font-bold text-white flex items-center gap-2"><i class="ph-bold ph-info text-sky-400"></i>AI Verdict</h3>
          <p class="text-slate-300 mt-2" id="summary-verdict"></p>
      </div>
     </div>
  </template>

  <template id="ai-best-value-template">
     <div class="p-4 sm:p-8 relative">
      <button onclick="closeModal()" class="fixed top-6 left-8 text-white bg-black/30 backdrop-blur-sm hover:bg-black/50 p-3 rounded-full z-50 transition-colors">
          <i class="ph-bold ph-arrow-left text-2xl"></i>
      </button>
      <div class="text-center mb-8">
          <h2 class="text-3xl font-bold text-white">AI Best Value Analysis</h2>
           <p class="text-slate-400 mt-2" id="best-value-location"></p>
      </div>

      <div class="text-center mb-8">
          <p class="text-lg text-slate-400">AI Value Rating</p>
          <p class="text-5xl font-extrabold" id="best-value-rating">Excellent</p>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-8">
          <div class="bg-card-elevated p-6 rounded-lg border border-border-dark text-center">
              <h4 class="font-semibold text-slate-400">Listing Price</h4>
              <p class="text-3xl font-bold text-white" id="best-value-listing-price"></p>
          </div>
           <div class="bg-card-elevated p-6 rounded-lg border border-border-dark text-center">
              <h4 class="font-semibold text-slate-400">AI Estimated Market Value</h4>
              <p class="text-3xl font-bold text-white" id="best-value-estimated-price"></p>
          </div>
      </div>
      
      <div class="bg-card-elevated p-6 rounded-lg border border-border-dark">
          <h3 class="text-xl font-bold text-white flex items-center gap-2"><i class="ph-bold ph-chart-bar text-amber-400"></i>Analysis Breakdown</h3>
          <div class="text-slate-300 mt-2 prose prose-invert max-w-none" id="best-value-analysis"></div>
      </div>
     </div>
  </template>

<script>
/**************************************/
/***** 1) Config & State **************/
/**************************************/

// --- Supabase Configuration ---
const SUPABASE_URL = 'https://usmzzjnoqzdqjxfzwcjn.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVzbXp6am5vcXpkcWp4Znp3Y2puIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc0MTYxMjQsImV4cCI6MjA3Mjk5MjEyNH0.j-rcyzZnJTWtgnscN350OEa8O9q_3EIiVdIn0E0s2Sc';
const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

const state = {
    plots: [],
    currentUser: null,
    cities: ['Pune', 'Mumbai', 'Bengaluru', 'Delhi NCR'],
    activeCity: 'Pune',
    activePropertyType: 'Plots',
    activeListingType: 'Buy',
    selectedPlotIds: new Set(),
    selectedPosition: { lat: 18.5913, lng: 73.7423 }, // Default to Pune
    priceChart: null,
    loginVisualId: null,
    contextPlot: null,
    plan: 'free',
    googleMapsReady: false, 
    googleMapsResolve: null,
    plotImages: [],
    aadhaarFile: null, 
    sevTwelveFile: null, 
    apiKeys: {
        gemini: localStorage.getItem('avas_gemini_api_key'),
        google: localStorage.getItem('avas_google_maps_api_key'),
    },
};

const dom = {
    header: document.querySelector('header'),
    plotGrid: document.getElementById('plot-grid'),
    cityFilter: document.getElementById('city-filter'),
    searchTabs: document.getElementById('search-tabs'),
    compareBtn: document.getElementById('compare-btn'),
    summarizeBtn: document.getElementById('summarize-btn'),
    bestValueBtn: document.getElementById('best-value-btn'),
    feedbackToast: document.getElementById('feedback-toast'),
    advertiseBtn: document.getElementById('advertise-btn'),
    subscriptionBtn: document.getElementById('subscription-btn'),
    plotsNavLink: document.getElementById('plots-nav-link'),
    landNavLink: document.getElementById('land-nav-link'),
    categoryBrowser: document.getElementById('category-browser'),
    browseHeading: document.getElementById('browse-heading'),
    settingsBtn: document.getElementById('settings-btn'),
    modal: {
        wrapper: document.getElementById('modal-wrapper'),
        content: document.querySelector('.modal-content'),
        title: document.getElementById('modal-title'),
        body: document.getElementById('modal-body'),
        closeBtn: document.getElementById('modal-close-btn'),
    },
    auth: {
        container: document.getElementById('auth-container'),
        loginBtn: document.getElementById('login-btn'),
        userProfile: document.getElementById('user-profile'),
        addPlotBtn: document.getElementById('add-plot-btn'),
    },
    chat: {
        window: null, context: null, box: null, starters: null, input: null, sendBtn: null,
    },
};

/**************************************/
/***** 2) Init & Event Listeners *****/
/**************************************/
document.addEventListener('DOMContentLoaded', async () => {
    setupEventListeners();
    loadGoogleMaps();
    renderCategories();
    renderCityFilters();
    await handleAuthStateChange();
    fetchPlotsByCity(state.activeCity);
    updateActiveNavLinks();
    updateAdRibbon();
    initScrollAnimations();
});

function setupEventListeners() {
    window.addEventListener('scroll', () => {
        dom.header.classList.toggle('scrolled', window.scrollY > 50);
    });
    
    dom.settingsBtn.addEventListener('click', openSettingsModal);
    dom.modal.closeBtn.addEventListener('click', closeModal);
    dom.modal.wrapper.addEventListener('click', e => { if (e.target === dom.modal.wrapper) closeModal(); });

    dom.cityFilter.addEventListener('click', e => { if (e.target.tagName === 'BUTTON') fetchPlotsByCity(e.target.dataset.city); });
    
    dom.searchTabs.addEventListener('click', e => {
        if (!e.target.matches('.hero-search-tab')) return;
        const searchType = e.target.dataset.searchType;
        
        dom.searchTabs.querySelectorAll('.hero-search-tab').forEach(t => t.classList.remove('active'));
        e.target.classList.add('active');

        const citySearch = document.getElementById('city-search-form');
        const lifestyleSearch = document.getElementById('lifestyle-search-container');

        if (searchType === 'location') {
            citySearch.style.display = 'flex';
            lifestyleSearch.style.display = 'none';
        } else {
            citySearch.style.display = 'none';
            lifestyleSearch.style.display = 'block';
        }
    });

    document.body.addEventListener('click', e => {
        if (e.target.closest('#lifestyle-search-btn')) {
            handleLifestyleSearch();
        }
    });

    dom.categoryBrowser.addEventListener('click', e => {
        const card = e.target.closest('.category-card'); if (!card) return;
        const category = card.dataset.category;
         if (category === 'Land') {
             state.activePropertyType = 'Land';
             fetchPlotsByCity(state.activeCity, 'Land');
        } else {
             state.activePropertyType = 'Plots';
             fetchPlotsByCity(state.activeCity, null);
        }
         updateActiveNavLinks();
    });
    
    dom.plotsNavLink.addEventListener('click', e => { e.preventDefault(); state.activePropertyType = 'Plots'; updateActiveNavLinks(); fetchPlotsByCity(state.activeCity, null); });
    dom.landNavLink.addEventListener('click', e => { e.preventDefault(); state.activePropertyType = 'Land'; updateActiveNavLinks(); fetchPlotsByCity(state.activeCity, 'Land'); });
    
    dom.plotGrid.addEventListener('change', e => {
        if (!e.target.classList.contains('select-plot-checkbox')) return;
        const id = e.target.dataset.id;
        if (e.target.checked) {
            if (state.selectedPlotIds.size < 2) {
                state.selectedPlotIds.add(id);
            } else {
                e.target.checked = false;
                showFeedbackToast('Select up to 2 plots only.', 'bg-red-500');
            }
        } else {
            state.selectedPlotIds.delete(id);
        }
        updateAiActionButtons();
    });
    
    dom.plotGrid.addEventListener('click', e => {
        if (e.target.closest('.ask-ai-btn')) {
            e.stopPropagation();
            const button = e.target.closest('.ask-ai-btn');
            setChatContext(button.dataset.id);
        }
    });

    dom.compareBtn.addEventListener('click', handleCompareClick);
    dom.summarizeBtn.addEventListener('click', handleSummarizeClick);
    dom.bestValueBtn.addEventListener('click', handleBestValueClick);

    dom.advertiseBtn.addEventListener('click', openAdvertiseModal);
    dom.subscriptionBtn?.addEventListener('click', openSubscriptionModal);
    dom.auth.loginBtn?.addEventListener('click', openLoginModal);
    dom.auth.addPlotBtn?.addEventListener('click', openAddPlotModalGuarded);

    document.body.addEventListener('click', e => {
        if (e.target.closest('#profile-btn')) {
            openUserProfileModal();
        }
    });

    supabaseClient.auth.onAuthStateChange((event, session) => {
        handleAuthStateChange(session);
    });
}

function initScrollAnimations() {
    const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                entry.target.classList.add('in-view');
                observer.unobserve(entry.target);
            }
        });
    }, { threshold: 0.1 });
    document.querySelectorAll('.animate-on-scroll').forEach(el => observer.observe(el));
}

/**************************************/
/***** 3) Data Fetch & Rendering *****/
/**************************************/

async function fetchPlotsByCity(city, category = null) {
    showGridLoader();
    state.activeCity = city;
    dom.browseHeading.textContent = `Featured Listings in ${city}`;
    state.selectedPlotIds.clear();
    updateAiActionButtons();

    try {
        let query = supabaseClient.from('plots').select('*').eq('city', city).eq('status', 'Available');

        if (state.activeListingType === 'Buy') {
            query = query.neq('listing_type', 'For Rent');
        } else if (state.activeListingType === 'Rent') {
            query = query.eq('listing_type', 'For Rent');
        }
        
        if (category === 'Land') {
            query = query.in('property_type', ['NA Plot', 'Agricultural Land']);
        }

        query = query.order('created_at', { ascending: false });

        const { data, error } = await query;
        if (error) throw error;

        state.plots = data;
        renderPlotCards();
    } catch (error) {
        console.error("Error fetching plots from Supabase:", error);
        showFeedbackToast('Could not fetch plot data.', 'bg-red-500');
        dom.plotGrid.innerHTML = `<div class="col-span-full text-center py-10"><p class="text-slate-400">Could not load plots. Please check the console.</p></div>`;
    } finally {
        updateActiveCityButton();
        initScrollAnimations();
    }
}


function renderPlotCards(plotsToRender = state.plots) {
    dom.plotGrid.innerHTML = '';
    if (plotsToRender.length === 0) {
        dom.plotGrid.innerHTML = `<div class="col-span-full text-center py-10"><i class="ph-bold ph-info text-6xl text-slate-500 mb-4"></i><p class="text-slate-400">No plots found for this criteria.</p></div>`;
        return;
    }

    const cardTemplate = document.getElementById('plot-card-template').innerHTML;
    plotsToRender.forEach((plot) => {
        const timeSince = new Date() - new Date(plot.created_at);
        const isNew = timeSince < 48 * 60 * 60 * 1000;

        let tagsHtml = '';
        if (isNew) tagsHtml += '<div class="bg-blue-600/50 text-white px-2 py-1 text-xs font-semibold rounded-full">New</div>';
        if (plot.is_verified) tagsHtml += '<div class="bg-green-600/50 text-white px-2 py-1 text-xs font-semibold rounded-full flex items-center gap-1"><i class="ph-bold ph-check-circle"></i>Verified</div>';
        
        const imageUrl = Array.isArray(plot.image_urls) && plot.image_urls.length > 0 ? plot.image_urls[0] : 'https://placehold.co/600x400/1e293b/e2e8f0?text=No+Image';

        const cardHtml = cardTemplate
            .replaceAll('{id}', plot.id)
            .replace('{image_url}', imageUrl)
            .replace('{location}', plot.location)
            .replace('{tags}', tagsHtml)
            .replace('{property_type}', (plot.property_type || '').toUpperCase())
            .replace('{price}', `₹${formatIndianCurrency(plot.price)}`)
            .replace('{area_sqft}', plot.area_sqft)
            .replace('{city}', plot.city);
        
        dom.plotGrid.insertAdjacentHTML('beforeend', cardHtml);
    });
}

function renderCategories() {
    const cats = [
        { name: 'New Listings', image: 'https://images.pexels.com/photos/106399/pexels-photo-106399.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=1' },
        { name: 'Price Reduced', image: 'https://images.pexels.com/photos/209296/pexels-photo-209296.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=1' },
        { name: 'Land', image: 'https://images.pexels.com/photos/209315/pexels-photo-209315.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=1' },
        { name: 'Residential', image: 'https://images.pexels.com/photos/208736/pexels-photo-208736.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=1' },
    ];
    dom.categoryBrowser.innerHTML = cats.map(cat => `
    <div class="category-card animate-on-scroll" data-category="${cat.name}">
      <img src="${cat.image}" alt="${cat.name}">
      <div class="category-card-overlay">
         <h3 class="text-white text-lg font-bold">${cat.name}</h3>
      </div>
    </div>`).join('');
}

function renderCityFilters() {
    dom.cityFilter.innerHTML = state.cities.map(c => `<button class="city-filter-btn px-5 py-2 rounded-full font-semibold bg-slate-800 text-slate-300 hover:bg-slate-700" data-city="${c}">${c}</button>`).join('');
    updateActiveCityButton();
}


/**************************************/
/***** 4) Modals (Shell & Content) *****/
/**************************************/

function openModal(title, bodyHtml, options = {}) {
  const { isFullScreen = false, customClass = '' } = options;
    dom.modal.title.textContent = title;
    dom.modal.body.innerHTML = bodyHtml;
    
    dom.modal.content.className = `modal-content rounded-2xl shadow-xl transform opacity-0 -translate-y-4 ${customClass}`;

    if (isFullScreen) {
        dom.modal.content.classList.add('w-screen', 'h-screen', 'rounded-none', 'max-w-full');
        dom.modal.title.parentElement.classList.add('hidden');
        dom.modal.body.className = 'p-0 h-full overflow-y-auto';
    } else {
        dom.modal.content.classList.add('w-11/12', 'md:max-w-4xl');
        dom.modal.title.parentElement.classList.remove('hidden');
        dom.modal.body.className = 'p-6 max-h-[80vh] overflow-y-auto';
    }

    dom.modal.wrapper.classList.remove('pointer-events-none', 'opacity-0');
    setTimeout(() => {
        dom.modal.content.classList.remove('opacity-0', '-translate-y-4');
    }, 10);
    document.body.style.overflow = 'hidden';
}

function closeModal() {
    dom.modal.content.classList.add('opacity-0', '-translate-y-4');
    dom.modal.wrapper.classList.add('opacity-0');
    setTimeout(() => {
        if (state.loginVisualId) { cancelAnimationFrame(state.loginVisualId); state.loginVisualId = null; }
        dom.modal.wrapper.classList.add('pointer-events-none');
        dom.modal.body.innerHTML = '';
    }, 300);
    document.body.style.overflow = '';
}

 function openSettingsModal() {
    const template = document.getElementById('settings-modal-template').innerHTML;
    openModal('Settings', template, { customClass: 'md:max-w-lg' });
    
    const form = dom.modal.body.querySelector('#api-key-form');
    const geminiInput = form.querySelector('#gemini-api-key');
    const googleInput = form.querySelector('#google-maps-api-key');

    geminiInput.value = state.apiKeys.gemini;
    googleInput.value = state.apiKeys.google;

    dom.modal.body.querySelectorAll('.toggle-vis').forEach(btn => {
         btn.addEventListener('click', (e) => {
             const input = e.currentTarget.previousElementSibling;
             const icon = e.currentTarget.querySelector('i');
             if (input.type === 'password') {
                 input.type = 'text';
                 icon.classList.replace('ph-eye', 'ph-eye-slash');
             } else {
                 input.type = 'password';
                 icon.classList.replace('ph-eye-slash', 'ph-eye');
             }
         });
    });

    form.addEventListener('submit', e => {
        e.preventDefault();
        state.apiKeys.gemini = geminiInput.value.trim();
        state.apiKeys.google = googleInput.value.trim();
        localStorage.setItem('avas_gemini_api_key', state.apiKeys.gemini);
        localStorage.setItem('avas_google_maps_api_key', state.apiKeys.google);
        
        showFeedbackToast('API Keys saved successfully!', 'bg-green-600');
        closeModal();
        
        if (state.apiKeys.google && !window.google && !document.querySelector('script[src*="maps.googleapis.com"]')) {
            loadGoogleMaps();
        }
    });
}

function openLoginModal() {
  openModal('', document.getElementById('new-login-template').innerHTML, { isFullScreen: true });
  initLoginListeners(); 
}

async function openPlotDetailModal(plotId) {
    const template = document.getElementById('plot-detail-template').innerHTML;
    openModal('Plot Details', template, { isFullScreen: true });
    
    let plot = state.plots.find(p => p.id == plotId);

    if (!plot) {
        try {
            const { data, error } = await supabaseClient.from('plots').select('*').eq('id', plotId).single();
            if (error) throw error;
            plot = data;
        } catch (error) {
            console.error('Error fetching plot details from Supabase:', error);
            showFeedbackToast('Could not load plot details.', 'bg-red-500');
            closeModal();
            return;
        }
    }
    
    if (!plot) {
        showFeedbackToast('Could not find plot details.', 'bg-red-500');
        closeModal();
        return;
    }

    const modalBody = dom.modal.body;
    modalBody.querySelector('#detail-close-btn').addEventListener('click', closeModal);

    const imageUrl = Array.isArray(plot.image_urls) && plot.image_urls.length > 0 ? plot.image_urls[0] : 'https://placehold.co/600x400/1e293b/e2e8f0?text=No+Image';
    modalBody.querySelector('#plot-detail-img').src = imageUrl;
    modalBody.querySelector('#plot-detail-location').textContent = plot.location;
    modalBody.querySelector('#plot-detail-city').textContent = plot.city;
    modalBody.querySelector('#plot-detail-price').textContent = `₹${formatIndianCurrency(plot.price)}`;
    modalBody.querySelector('#vastu-score').textContent = `${plot.vastu_score || 'N/A'}/100`;

    const badgeEl = modalBody.querySelector('#plot-detail-verified-badge');
    badgeEl.innerHTML = plot.is_verified
        ? `<div class="flex items-center gap-1 bg-green-600 text-white text-sm font-bold px-3 py-1 rounded-full"><i class="ph-bold ph-check-circle"></i>Verified</div>`
        : `<div class="flex items-center gap-1 bg-slate-600 text-white text-sm font-bold px-3 py-1 rounded-full"><i class="ph-bold ph-x-circle"></i>Unverified</div>`;

    const totalGrowth = (Math.pow(1.10, 5) - 1) * 100;
    modalBody.querySelector('#plot-detail-prediction').textContent = `~ ${totalGrowth.toFixed(1)}% Increase`;

    const summaryEl = modalBody.querySelector('#ai-summary');
    summaryEl.innerHTML = '<div class="flex items-center gap-2 text-sm text-slate-400"><div class="w-4 h-4 border-2 border-slate-500 border-t-slate-300 rounded-full animate-spin"></div><span>Generating AI summary...</span></div>';
    
    const summaryData = await getAISummary(plot);
    const summary = JSON.parse(summaryData);
    summaryEl.textContent = summary.verdict || "AI could not generate a summary.";

    renderContactSellerSection(plot);

    await ensureGoogleMapsReady();
    renderPriceChart(plot.price);
    const lat = plot.latitude ? parseFloat(plot.latitude) : state.selectedPosition.lat;
    const lng = plot.longitude ? parseFloat(plot.longitude) : state.selectedPosition.lng;
    initializeMapForModal('neighborhood-map', { lat, lng }, false);
}

function renderContactSellerSection(plot) {
    const contactSection = dom.modal.body.querySelector('#contact-seller-section');
    if (!contactSection) return;
    let contactHtml = '';

    if (state.currentUser) {
        if (state.plan === 'free') {
            contactHtml = `
                <div class="mt-6 p-4 rounded-lg bg-slate-800/50 border border-amber-500/50 text-center">
                    <h3 class="text-xl font-bold mb-2 flex items-center justify-center gap-2 text-white"><i class="ph-bold ph-lock text-amber-400"></i>Contact Seller</h3>
                    <p class="text-sm text-slate-400 mb-4">Upgrade to a premium plan to view seller contact details and send messages directly.</p>
                    <button onclick="openSubscriptionModal()" class="w-full py-2 bg-amber-600 text-white font-semibold rounded-lg hover:bg-amber-700 transition-colors">Upgrade Plan</button>
                </div>`;
        } else {
            // In a real app, you'd fetch seller info from your 'users' table based on plot.user_id
            contactHtml = `
                <div class="mt-6 p-4 rounded-lg bg-slate-800/50 border border-slate-700">
                    <h3 class="text-xl font-bold mb-2 flex items-center gap-2 text-white"><i class="ph-bold ph-phone text-indigo-400"></i>Contact Seller</h3>
                    <p class="text-slate-300"><strong>Name:</strong> John Doe (Mock Seller)</p>
                    <p class="text-slate-300"><strong>Email:</strong> seller@example.com</p>
                    <p class="text-slate-300 mb-3"><strong>Phone:</strong> +91 98765 43210</p>
                    <a href="mailto:seller@example.com?subject=Inquiry%20about%20plot%20in%20${encodeURIComponent(plot.location)}" class="w-full block text-center py-2 bg-indigo-600 text-white font-semibold rounded-lg hover:bg-indigo-700 transition-colors">
                        <i class="ph-bold ph-envelope"></i> Email Seller
                    </a>
                </div>`;
        }
    } else {
        contactHtml = `
            <div class="mt-6 p-4 rounded-lg bg-slate-800/50 border border-slate-700 text-center">
                <h3 class="text-xl font-bold mb-2 flex items-center justify-center gap-2 text-white"><i class="ph-bold ph-sign-in text-indigo-400"></i>Contact Seller</h3>
                <p class="text-sm text-slate-400 mb-4">Please log in to contact the seller.</p>
                <button onclick="openLoginModal()" class="w-full py-2 bg-indigo-600 text-white font-semibold rounded-lg hover:bg-indigo-700 transition-colors">Login to Continue</button>
            </div>`;
    }
    contactSection.innerHTML = contactHtml;
}

async function openAddPlotModal() {
    state.plotImages = [];
    state.aadhaarFile = null;
    state.sevTwelveFile = null;
    openModal('Add a New Plot', document.getElementById('add-plot-template').innerHTML, {customClass: 'md:max-w-4xl'});
    updateStepIndicator(1);
    initAddPlotFormListeners();
}

function openSubscriptionModal() {
    openModal('Subscription', document.getElementById('subscription-modal-template').innerHTML);
    dom.modal.body.querySelectorAll('.plan-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
            const plan = e.currentTarget.dataset.plan;
            const amount = e.currentTarget.dataset.amount;
            if (plan !== 'free') {
                handleSubscriptionPayment(plan, amount);
            }
        });
    });
}

function openAdvertiseModal() {
    openModal('Advertise with Us', document.getElementById('advertise-modal-template').innerHTML);
    dom.modal.body.querySelector('#adv-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        console.log("Advertising form submitted.");
        closeModal();
        showFeedbackToast('Advertising inquiry submitted.', 'bg-green-600');
    });
}


/**************************************/
/***** 5) API & AI Logic **************/
/**************************************/

function loadGoogleMaps() {
    if (state.apiKeys.google && !window.google) {
        const googleMapsPromise = new Promise(resolve => {
            state.googleMapsResolve = resolve;
        });
        state.googleMapsPromise = googleMapsPromise;

        const script = document.createElement('script');
        script.src = `https://maps.googleapis.com/maps/api/js?key=${state.apiKeys.google}&callback=initMap&libraries=places`;
        script.async = true;
        document.head.appendChild(script);
    } else if (!state.apiKeys.google) {
        console.warn("Google Maps API key not set. Map features will be disabled.");
    }
}

window.initMap = () => {
    console.log("Google Maps script loaded and ready.");
    state.googleMapsReady = true;
    if (state.googleMapsResolve) {
        state.googleMapsResolve();
    }
}

function ensureGoogleMapsReady() {
    if (state.googleMapsReady) {
        return Promise.resolve();
    }
    if (state.googleMapsPromise) {
        return state.googleMapsPromise;
    }
    return Promise.reject("Google Maps not initialized");
}

const AI_SYSTEM_PROMPT = `You are AVAS AI, a world-class real estate and investment advisor for the Indian market. Your expertise includes property valuation, investment strategies, location analysis, market trends, Vastu Shastra, and understanding legal documents. Provide clear, structured, and actionable advice. Always use Markdown for formatting. If a 'Context Plot' JSON object is provided in the user's query, your answers MUST be based primarily on that data to answer questions specifically about that property. If no context is given, answer generally.`;

async function callGeminiAPI(prompt, useJson = true) {
    if (!state.apiKeys.gemini) {
        openSettingsModal();
        return useJson ? '{"error": "Gemini API key is not set. Please add it in the settings."}' : "Error: Gemini API key is not set.";
    }
    
    const payload = {
      contents: [{ parts: [{ text: prompt }] }],
      systemInstruction: { parts: [{ text: AI_SYSTEM_PROMPT }] }
    };

    const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${state.apiKeys.gemini}`;
    try {
        const res = await fetch(url, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });
        if (!res.ok) {
            const data = await res.json();
            throw new Error(`Gemini HTTP ${res.status}: ${data.error.message}`);
        }
        const data = await res.json();
        const part = data?.candidates?.[0]?.content?.parts?.[0];
        const text = part?.text.replace(/```json/g, '').replace(/```/g, '').trim();
        return text || (useJson ? '{"error": "No content received from AI."}' : "No content from AI.");
    } catch (err) {
        console.error(err);
        showFeedbackToast("AI API call failed. Check console.", "bg-red-500");
        return useJson ? `{"error": "Sorry, the AI is currently unavailable. Error: ${err.message}"}` : "Sorry, AI is unavailable.";
    }
}

async function getAIResponse(q, contextPlot = null) { 
    let prompt = `User query: "${q}"`;
    if (contextPlot) {
        prompt = `Context Plot: ${JSON.stringify(contextPlot)}\n\nUser query about this plot: "${q}"`;
    }
    return await callGeminiAPI(prompt, false);
 }

async function getAIComparison(p1, p2) {
    const prompt = `You are a real estate AI. Compare these two plots. Respond with only a valid JSON object.
    Plot 1: ${JSON.stringify(p1)}
    Plot 2: ${JSON.stringify(p2)}
    JSON format: { "recommendation": "Markdown formatted summary of which plot is better and why." } `;
    return await callGeminiAPI(prompt);
}

async function getAISummary(plot) {
    const prompt = `You are a real estate AI. Provide a summary for this plot. Respond with only a valid JSON object.
    Plot: ${JSON.stringify(plot)}
    JSON format: { "pros": ["short pro 1", "short pro 2"], "cons": ["short con 1", "short con 2"], "verdict": "A concise, one-sentence final verdict." }`;
    return await callGeminiAPI(prompt);
}

async function getAIBestValue(plot) {
  const plotPrice = plot.price;
  const estimatedPrice = plotPrice * (Math.random() * 0.2 + 0.9);
  const formattedEstimatedPrice = `₹${formatIndianCurrency(estimatedPrice)}`;
    const prompt = `You are a real estate AI. Analyze this plot's value. Respond with only a valid JSON object.
    Plot: ${JSON.stringify(plot)}
    Estimated Market Value is ${formattedEstimatedPrice}.
    JSON format: { "rating": "Excellent|Good|Fair", "analysis": "Markdown formatted brief explanation for the rating." } `;
    return await callGeminiAPI(prompt);
}

/**************************************/
/***** 6) Helpers & Utilities *********/
/**************************************/

function showFeedbackToast(msg, color) {
    const toast = dom.feedbackToast;
    if (!toast) return;
    toast.textContent = msg;
    toast.className = `text-sm font-semibold absolute -top-12 left-1/2 -translate-x-1/2 w-max px-4 py-2 rounded-md shadow-lg transition-all duration-300 ${color}`;
    toast.classList.remove('opacity-0');
    setTimeout(() => toast.classList.add('opacity-0'), 3000);
}

function toggleChat() {
    const template = document.getElementById('chat-modal-template').innerHTML;
    openModal('24/7 AI Support', template, { customClass: 'md:max-w-xl h-4/5' });
    
    dom.chat.context = document.getElementById('chat-context');
    dom.chat.box = document.getElementById('chat-box');
    dom.chat.starters = document.getElementById('chat-starters');
    dom.chat.input = document.getElementById('chat-input');
    dom.chat.sendBtn = document.getElementById('chat-send-btn');
    
    dom.chat.sendBtn.addEventListener('click', handleChatInput);
    dom.chat.input.addEventListener('keydown', e => { if (e.key === 'Enter') handleChatInput(); });
    dom.chat.starters.addEventListener('click', e => { if (e.target.matches('.chat-starter-btn')) { dom.chat.input.value = e.target.textContent; handleChatInput(); } });

    updateChatContextUI();
    updateChatStarters();
}


function updateAdRibbon() {
  let ribbon = document.getElementById('avas-ad-ribbon');
  if (!ribbon) {
    ribbon = document.createElement('div');
    ribbon.id = 'avas-ad-ribbon';
    ribbon.className = 'fixed top-0 left-0 right-0 z-50 text-center text-xs md:text-sm';
    document.body.prepend(ribbon);
  }
  if (state.plan === 'free') {
    ribbon.innerHTML = `<div class="bg-indigo-900/70 backdrop-blur border-b border-indigo-800 text-indigo-200 px-3 py-2 flex items-center justify-center"><span>Sponsored: Upgrade to remove ads.</span><button id="close-ad-ribbon" class="ml-4 text-indigo-200 hover:text-white">&times;</button></div>`;
    ribbon.style.display = 'block';
    document.querySelector('header').style.top = '30px';
    document.getElementById('close-ad-ribbon').addEventListener('click', () => {
        ribbon.style.display = 'none';
        document.querySelector('header').style.top = '0px';
    });
  } else {
    ribbon.style.display = 'none';
    document.querySelector('header').style.top = '0px';
  }
}

async function handleAuthStateChange(session) {
    const user = session?.user;
    state.currentUser = user || null;

    if (user) {
        const { data: profile } = await supabaseClient.from('users').select('role').eq('id', user.id).single();
        
        if (profile && !profile.role) {
            openRoleSelectionModal();
        }

        const { data, error } = await supabaseClient
            .from('subscriptions')
            .select('plan')
            .eq('user_id', user.id)
            .eq('status', 'active')
            .order('created_at', { ascending: false })
            .limit(1)
            .single();

        state.plan = data?.plan || 'free';
    } else {
        state.plan = 'free';
    }
    updateAdRibbon();
    
    dom.auth.container?.classList.toggle('hidden', !!user);
    if (dom.auth.userProfile) {
        dom.auth.userProfile.classList.toggle('hidden', !user);
        dom.auth.userProfile.classList.toggle('flex', !!user);
    }

    if (user && dom.auth.userProfile) {
        const name = user.user_metadata?.full_name || user.email?.split('@')[0] || user.phone;
        const pic = user.user_metadata?.avatar_url || `https://placehold.co/40x40/1e293b/e2e8f0?text=${name.charAt(0).toUpperCase()}`;
        
        dom.auth.userProfile.innerHTML = `
        <button id="profile-btn" class="flex items-center gap-2 text-white font-semibold">
          <img src="${pic}" class="w-10 h-10 rounded-full object-cover">
        </button>
        <button id="signout-btn" class="p-2 rounded-full text-slate-300 hover:bg-slate-800"><i class="ph-bold ph-sign-out text-2xl"></i></button>`;
        
        document.getElementById('signout-btn').addEventListener('click', async () => {
            const { error } = await supabaseClient.auth.signOut();
            if (error) {
                showFeedbackToast(`Sign out failed: ${error.message}`, 'bg-red-500');
            } else {
                dom.auth.userProfile.innerHTML = '';
                showFeedbackToast('Signed out successfully.', 'bg-green-600');
            }
        });
    }
}


function updateActiveNavLinks() { dom.plotsNavLink.classList.toggle('active', state.activePropertyType === 'Plots'); dom.landNavLink.classList.toggle('active', state.activePropertyType === 'Land'); }
function updateAiActionButtons() { const c = state.selectedPlotIds.size; dom.compareBtn.disabled = c !== 2; dom.compareBtn.innerHTML = `<i class="ph-bold ph-git-compare"></i> Compare (${c}/2)`; dom.summarizeBtn.disabled = c !== 1; dom.summarizeBtn.innerHTML = `<i class="ph-bold ph-sparkle"></i> Summarize (${c === 1 ? '1' : '0'})`; dom.bestValueBtn.disabled = c !== 1; dom.bestValueBtn.innerHTML = `<i class="ph-bold ph-tag"></i> Best Value (${c === 1 ? '1' : '0'})`; }
function showGridLoader() { dom.plotGrid.innerHTML = `<div class="col-span-full flex items-center justify-center py-20"><div class="loader"></div></div>`; }
function updateActiveCityButton() { dom.cityFilter.querySelectorAll('button').forEach(btn => btn.classList.toggle('active', btn.dataset.city === state.activeCity)); }

async function handleCompareClick() {
  const plots = Array.from(state.selectedPlotIds).map(id => state.plots.find(p => p.id == id));
  if (plots.length !== 2 || plots.includes(undefined)) { showFeedbackToast('Please select exactly 2 plots to compare.', 'bg-red-500'); return; }
  await handleAiAction('AI Comparison', getAIComparison, plots);
}

async function handleSummarizeClick() {
  const plot = state.plots.find(p => p.id == Array.from(state.selectedPlotIds)[0]);
  if (!plot) { showFeedbackToast('Please select a plot to summarize.', 'bg-red-500'); return; }
  await handleAiAction('AI Summary', getAISummary, [plot]);
}

async function handleBestValueClick() {
  const plot = state.plots.find(p => p.id == Array.from(state.selectedPlotIds)[0]);
  if (!plot) { showFeedbackToast('Please select a plot to analyze.', 'bg-red-500'); return; }
  await handleAiAction('AI Best Value Analysis', getAIBestValue, [plot]);
}

async function handleChatInput() { 
    if (!dom.chat.input) return;
    const message = dom.chat.input.value.trim(); 
    if (message === '') return; 
    dom.chat.input.value = ''; 
    displayChatMessage('user', message); 
    const thinking = displayChatMessage('ai', 'Thinking...', true); 
    const response = await getAIResponse(message, state.contextPlot); 
    try {
        const parsedResponse = JSON.parse(response);
        thinking.innerHTML = `<i class="ph-bold ph-robot text-indigo-400 text-xl mr-2"></i><span>${parsedResponse.error || "Sorry, I couldn't process that."}</span>`;
    } catch (e) {
         thinking.innerHTML = `<i class="ph-bold ph-robot text-indigo-400 text-xl mr-2"></i><span>${marked.parse(response)}</span>`;
    }
    
    dom.chat.box.scrollTop = dom.chat.box.scrollHeight; 
}

function displayChatMessage(sender, message, isThinking = false) { if(!dom.chat.box) return; const div = document.createElement('div'); div.classList.add('flex', 'items-start', 'gap-3', 'max-w-full', 'mb-4'); if (sender === 'user') { div.classList.add('justify-end'); div.innerHTML = `<div class="chat-bubble-user text-white p-3 rounded-lg max-w-xs break-words">${message}</div>`; } else { div.innerHTML = `<div class="chat-bubble-ai text-white p-3 rounded-lg max-w-xs break-words flex items-start"><i class="ph-bold ph-robot text-indigo-400 text-xl mr-2 flex-shrink-0"></i><span>${isThinking ? message : '...'}</span></div>`; } dom.chat.box.appendChild(div); dom.chat.box.scrollTop = dom.chat.box.scrollHeight; return div.querySelector('div:last-child > span') || div.querySelector('div:last-child'); }

function initLoginListeners() {
    const b = dom.modal.body;
    const form = b.querySelector('#auth-form');
    const phoneInput = b.querySelector('#phone');
    const otpInput = b.querySelector('#otp');
    const otpContainer = b.querySelector('#otp-container');
    const submitBtn = b.querySelector('#submitBtn');
    const googleBtn = b.querySelector('#google-signin-btn');
    const msg = b.querySelector('#message');

    let phoneOtpSent = false;

    b.querySelector('#login-close-btn')?.addEventListener('click', closeModal);

    googleBtn.addEventListener('click', async () => {
        const { error } = await supabaseClient.auth.signInWithOAuth({ provider: 'google' });
        if (error) msg.textContent = error.message;
    });

    form.addEventListener('submit', async (e) => {
        e.preventDefault();
        msg.textContent = '';
        submitBtn.disabled = true;

        try {
            let phone = phoneInput.value.replace(/\D/g, '');
            if (phone.length === 10) phone = `+91${phone}`;
            else if (phone.startsWith('91') && phone.length === 12) phone = `+${phone}`;

            if (!phoneOtpSent) {
                const { error } = await supabaseClient.auth.signInWithOtp({ phone });
                if (error) throw error;
                phoneOtpSent = true;
                showFeedbackToast('OTP sent to your phone!', 'bg-blue-600');
                otpContainer.classList.remove('hidden');
                submitBtn.textContent = 'Verify OTP & Sign In';
            } else {
                const otp = otpInput.value;
                const { data, error } = await supabaseClient.auth.verifyOtp({ phone, token: otp, type: 'sms' });
                if (error) throw error;
                showFeedbackToast('Signed in successfully!', 'bg-green-600');
                closeModal();
            }
        } catch (error) {
            msg.textContent = error.message;
        } finally {
            submitBtn.disabled = false;
        }
    });
}

function openRoleSelectionModal() {
    openModal('Select Your Role', document.getElementById('role-selection-modal-template').innerHTML, { customClass: 'md:max-w-lg' });
    
    const saveBtn = dom.modal.body.querySelector('#save-role-btn');
    saveBtn.addEventListener('click', async () => {
        const selectedRole = dom.modal.body.querySelector('input[name="role"]:checked').value;
        const user = state.currentUser;

        if (user) {
            const { error } = await supabaseClient
                .from('users')
                .update({ role: selectedRole })
                .eq('id', user.id);

            if (error) {
                showFeedbackToast(`Error saving role: ${error.message}`, 'bg-red-500');
            } else {
                showFeedbackToast('Profile updated!', 'bg-green-600');
                closeModal();
                handleAuthStateChange({ user }); // Re-run to update UI with new role
            }
        }
    });
}

function updateChatStarters() { 
    let starters = ['Investment strategies?', 'Best cities to invest?'];
    if (state.contextPlot) {
        starters = ['Summarize this plot.', 'What are the risks?'];
    } else if (state.selectedPlotIds.size === 1) {
        const plot = state.plots.find(p => p.id == Array.from(state.selectedPlotIds)[0]);
        if(plot) starters = [`Summarize plot in ${plot.location}`, `Is ${plot.location} a good investment?`];
    }
    
    if(dom.chat.starters) dom.chat.starters.innerHTML = starters.map(q => `<button class="chat-starter-btn text-xs text-left p-2 bg-slate-700/50 hover:bg-slate-700 rounded-md">${q}</button>`).join(''); 
}
function openAddPlotModalGuarded() { if (!state.currentUser) { openLoginModal(); } else { openAddPlotModal(); }}
function parseINR(str) {
    if (typeof str === 'number') return str;
    if (!str) return 0;
    const s = String(str).replace(/[₹,]/g, '').toLowerCase();
    const croreMatch = s.match(/(\d+\.?\d*)\s*crore/);
    if (croreMatch) return parseFloat(croreMatch[1]) * 10000000;
    const lakhMatch = s.match(/(\d+\.?\d*)\s*lakh/);
    if (lakhMatch) return parseFloat(lakhMatch[1]) * 100000;
    return parseFloat(s) || 0;
}

function formatIndianCurrency(num) {
    if (typeof num !== 'number') return num;
    const x = Math.round(num);
    if (x >= 10000000) return (x / 10000000).toFixed(2).replace(/\.00$/, '') + ' Crore';
    if (x >= 100000) return (x / 100000).toFixed(2).replace(/\.00$/, '') + ' Lakh';
    return x.toLocaleString('en-IN');
}
function renderPriceChart(currentPriceValue) {
  const ctx = dom.modal.body.querySelector('#price-trend-chart')?.getContext('2d');
  if (!ctx) return;
  if (state.priceChart) state.priceChart.destroy();
  const currentPrice = Number(currentPriceValue);
  const years = 5;
  const labels = Array.from({ length: years + 1 }, (_, i) => new Date().getFullYear() - years + i);
  const data = [];
  let price = currentPrice / Math.pow(1.08, years);
  for (let i = 0; i <= years; i++) {
       data.push(price);
       price *= (1 + (Math.random() * 0.05 + 0.06));
  }
  data[data.length - 1] = currentPrice;
  state.priceChart = new Chart(ctx, {
      type: 'line',
      data: { labels, datasets: [{ label: 'Estimated Property Value', data, borderColor: '#4f46e5', backgroundColor: 'rgba(79, 70, 229, 0.2)', fill: true, tension: 0.4 }] },
      options: { responsive: true, maintainAspectRatio: false, scales: { y: { ticks: { color: '#94a3b8', callback: value => `₹${formatIndianCurrency(value)}` }, grid: { color: 'rgba(148, 163, 184, 0.1)' } }, x: { ticks: { color: '#94a3b8' }, grid: { color: 'rgba(148, 163, 184, 0.1)' } } }, plugins: { legend: { display: false }, tooltip: { callbacks: { label: (context) => `Value: ₹${formatIndianCurrency(context.parsed.y)}` } } } }
  });
}
async function handleAiAction(title, getResponse, plots) {
    const loadingHtml = document.getElementById('ai-analysis-loading-template').innerHTML;
    openModal('', loadingHtml, { isFullScreen: true });

    const responseText = await getResponse(...plots);
    let data;
    try {
        data = JSON.parse(responseText);
        if(data.error) {
            showFeedbackToast(data.error, 'bg-red-500');
            closeModal();
            return;
        }
    } catch(e) {
        console.error("Failed to parse AI JSON response:", responseText);
        showFeedbackToast("AI response was not valid. Please try again.", "bg-red-500");
        closeModal();
        return;
    }
    
    if (title === 'AI Summary') {
        const template = document.getElementById('ai-summary-template').innerHTML;
        dom.modal.body.innerHTML = template;
        const plot = plots[0];
        dom.modal.body.querySelector('#summary-location').textContent = `For plot in ${plot.location}, ${plot.city}`;
        
        const highlightsContainer = dom.modal.body.querySelector('#summary-highlights');
        highlightsContainer.innerHTML = `
            <div class="bg-card-elevated p-4 rounded-lg"><p class="text-sm text-slate-400">Price</p><p class="text-xl font-bold text-white">₹${formatIndianCurrency(plot.price)}</p></div>
            <div class="bg-card-elevated p-4 rounded-lg"><p class="text-sm text-slate-400">Area</p><p class="text-xl font-bold text-white">${plot.area_sqft} sqft</p></div>
            <div class="bg-card-elevated p-4 rounded-lg"><p class="text-sm text-slate-400">Vastu</p><p class="text-xl font-bold text-white">${plot.vastu_score || 'N/A'}/100</p></div>
        `;

        const prosList = dom.modal.body.querySelector('#summary-pros ul');
        data.pros.forEach(pro => {
            prosList.innerHTML += `<li class="flex items-start gap-2"><i class="ph ph-check-circle text-green-400 mt-1"></i><span>${pro}</span></li>`;
        });
        
        const consList = dom.modal.body.querySelector('#summary-cons ul');
        data.cons.forEach(con => {
            consList.innerHTML += `<li class="flex items-start gap-2"><i class="ph ph-x-circle text-red-400 mt-1"></i><span>${con}</span></li>`;
        });

        dom.modal.body.querySelector('#summary-verdict').textContent = data.verdict;

    } else if(title === 'AI Best Value Analysis'){
        const template = document.getElementById('ai-best-value-template').innerHTML;
        dom.modal.body.innerHTML = template;
        const plot = plots[0];
        dom.modal.body.querySelector('#best-value-location').textContent = `For plot in ${plot.location}, ${plot.city}`;
        
        const ratingEl = dom.modal.body.querySelector('#best-value-rating');
        ratingEl.textContent = data.rating;
        if (data.rating === 'Excellent') ratingEl.classList.add('text-green-400');
        else if (data.rating === 'Good') ratingEl.classList.add('text-yellow-400');
        else ratingEl.classList.add('text-orange-400');

        dom.modal.body.querySelector('#best-value-listing-price').textContent = `₹${formatIndianCurrency(plot.price)}`;
        dom.modal.body.querySelector('#best-value-estimated-price').textContent = plot.price > 0 ? `~₹${formatIndianCurrency(plot.price * (Math.random() * 0.2 + 0.9))}` : "N/A";
        dom.modal.body.querySelector('#best-value-analysis').innerHTML = marked.parse(data.analysis);
        
    } else if(title === 'AI Comparison'){
        const comparisonTemplate = document.getElementById('ai-comparison-template').innerHTML;
        dom.modal.body.innerHTML = comparisonTemplate;
        const columnsContainer = dom.modal.body.querySelector('#comparison-columns');
        plots.forEach((plot, index) => {
            const imageUrl = Array.isArray(plot.image_urls) && plot.image_urls.length > 0 ? plot.image_urls[0] : 'https://placehold.co/600x400';
            columnsContainer.innerHTML += `
                <div class="bg-card-elevated p-4 rounded-lg border border-border-dark">
                    <h4 class="text-lg font-bold text-white mb-2">Plot ${index + 1}: ${plot.location}</h4>
                    <img src="${imageUrl}" class="w-full h-40 object-cover rounded-md mb-4">
                    <ul class="text-slate-300 space-y-2 text-sm">
                        <li><strong>Price:</strong> ₹${formatIndianCurrency(plot.price)}</li>
                        <li><strong>Area:</strong> ${plot.area_sqft} sqft</li>
                        <li><strong>Vastu:</strong> ${plot.vastu_score || 'N/A'}/100</li>
                    </ul>
                </div>`;
        });
        dom.modal.body.querySelector('#ai-recommendation').innerHTML = marked.parse(data.recommendation);
    } else {
         const backButton = `<button onclick="closeModal()" class="fixed top-6 left-8 text-white bg-black/30 backdrop-blur-sm hover:bg-black/50 p-3 rounded-full z-50 transition-colors"><i class="ph-bold ph-arrow-left text-2xl"></i></button>`;
          dom.modal.body.innerHTML = `${backButton}<div class="p-4 sm:p-8 md:p-12 prose prose-invert max-w-none">${marked.parse(data)}</div>`;
    }
}

function initAddPlotFormListeners() {
    const form = dom.modal.body.querySelector('#add-plot-form');
    if (!form) return;

    dom.modal.body.addEventListener('click', (e) => {
        if (e.target.matches('.next-btn, .prev-btn')) {
            const currentStepEl = e.target.closest('.form-step');
            const targetStep = e.target.dataset.next || e.target.dataset.prev;
            const targetStepEl = form.querySelector(`.form-step[data-step="${targetStep}"]`);
            if (targetStepEl) {
                currentStepEl.classList.add('hidden');
                targetStepEl.classList.remove('hidden');
                updateStepIndicator(targetStep);
                if (targetStep === '2') {
                    ensureGoogleMapsReady().then(() => {
                        initializeMapForModal('map', state.selectedPosition, true);
                    });
                }
            }
        }
    });

    const dropArea = form.querySelector('#image-drop-area');
    const imageInput = form.querySelector('#image-input');
    const previewArea = form.querySelector('#image-preview-area');

    const handleFiles = (files) => {
        for (const file of files) {
            if (state.plotImages.length < 5 && file.type.startsWith('image/')) {
                state.plotImages.push(file);
            }
        }
        renderImagePreviews();
    };

    const renderImagePreviews = () => {
        previewArea.innerHTML = '';
        state.plotImages.forEach((file, index) => {
            const reader = new FileReader();
            reader.onload = (e) => {
                const div = document.createElement('div');
                div.className = 'preview-image-container';
                div.innerHTML = `
                    <img src="${e.target.result}" class="preview-image" alt="preview">
                    <button type="button" class="remove-image-btn" data-index="${index}">&times;</button>
                `;
                previewArea.appendChild(div);
            };
            reader.readAsDataURL(file);
        });
    };
    
    dropArea.addEventListener('click', () => imageInput.click());
    imageInput.addEventListener('change', () => handleFiles(imageInput.files));
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        dropArea.addEventListener(eventName, (e) => { e.preventDefault(); e.stopPropagation(); }, false);
    });
    ['dragenter', 'dragover'].forEach(eventName => {
        dropArea.addEventListener(eventName, () => dropArea.classList.add('dragover'), false);
    });
    ['dragleave', 'drop'].forEach(eventName => {
        dropArea.addEventListener(eventName, () => dropArea.classList.remove('dragover'), false);
    });
    dropArea.addEventListener('drop', (e) => handleFiles(e.dataTransfer.files));
    previewArea.addEventListener('click', (e) => {
        if (e.target.classList.contains('remove-image-btn')) {
            const index = parseInt(e.target.dataset.index);
            state.plotImages.splice(index, 1);
            renderImagePreviews();
        }
    });

    const docDropAreas = [
        { area: form.querySelector('#aadhaar-drop-area'), input: form.querySelector('#aadhaar-input'), stateKey: 'aadhaarFile', nameEl: form.querySelector('#aadhaar-file-name') },
        { area: form.querySelector('#sev-twelve-drop-area'), input: form.querySelector('#sev-twelve-input'), stateKey: 'sevTwelveFile', nameEl: form.querySelector('#sev-twelve-file-name') }
    ];

    docDropAreas.forEach(({ area, input, stateKey, nameEl }) => {
        const handleDocFile = (file) => {
            if (file) {
                state[stateKey] = file;
                nameEl.textContent = file.name;
                area.classList.add('border-green-500');
            }
        };

        area.addEventListener('click', () => input.click());
        input.addEventListener('change', () => handleDocFile(input.files[0]));
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            area.addEventListener(eventName, (e) => { e.preventDefault(); e.stopPropagation(); }, false);
        });
        ['dragenter', 'dragover'].forEach(eventName => area.addEventListener(eventName, () => area.classList.add('dragover')));
        ['dragleave', 'drop'].forEach(eventName => area.addEventListener(eventName, () => area.classList.remove('dragover')));
        area.addEventListener('drop', (e) => handleDocFile(e.dataTransfer.files[0]));
    });

    form.addEventListener('submit', async (e) => {
        e.preventDefault();
        const submitBtn = form.querySelector('button[type="submit"]');
        const submitText = form.querySelector('#submit-text');
        const submitLoader = form.querySelector('#submit-loader');
        
        if (!state.currentUser) {
            showFeedbackToast('You must be logged in to submit a plot.', 'bg-red-500');
            return;
        }

        submitBtn.disabled = true;
        submitText.textContent = 'Uploading files...';
        submitLoader.classList.remove('hidden');
        
        try {
            const uploadFile = async (file, bucket) => {
                if (!file) return null;
                const fileName = `${state.currentUser.id}/${Date.now()}_${file.name}`;
                const { error } = await supabaseClient.storage.from(bucket).upload(fileName, file);
                if (error) throw error;
                const { data } = supabaseClient.storage.from(bucket).getPublicUrl(fileName);
                return data.publicUrl;
            };
            
            const imageUrls = await Promise.all(state.plotImages.map(file => uploadFile(file, 'plot-images')));
            const aadhaarUrl = await uploadFile(state.aadhaarFile, 'plot-documents');
            const sevTwelveUrl = await uploadFile(state.sevTwelveFile, 'plot-documents');

            submitText.textContent = 'Submitting plot...';
            const formData = new FormData(form);
            const plotData = {
                user_id: state.currentUser.id,
                city: state.activeCity,
                property_type: formData.get('property_type'),
                location: formData.get('location'),
                area_sqft: parseInt(formData.get('area_sqft')),
                price: parseINR(formData.get('price')),
                latitude: state.selectedPosition.lat,
                longitude: state.selectedPosition.lng,
                image_urls: imageUrls.length > 0 ? imageUrls.filter(Boolean) : null,
                aadhaar_url: aadhaarUrl,
                sev_twelve_url: sevTwelveUrl,
                is_verified: !!(aadhaarUrl && sevTwelveUrl),
            };

            const { error: insertError } = await supabaseClient.from('plots').insert([plotData]);
            if (insertError) throw insertError;
            
            showFeedbackToast('Plot submitted successfully!', 'bg-green-600');
            closeModal();
            fetchPlotsByCity(state.activeCity);
        } catch (error) {
            console.error("Error submitting plot:", error);
            showFeedbackToast(`Submission failed: ${error.message}`, 'bg-red-500');
        } finally {
            submitBtn.disabled = false;
            submitText.textContent = 'Verify with AI & Submit';
            submitLoader.classList.add('hidden');
        }
    });
}


async function initializeMapForModal(elementId, center, isDraggable) {
    await ensureGoogleMapsReady();
    const mapElement = dom.modal.body.querySelector(`#${elementId}`);
    if (!mapElement || !window.google) return;

    const map = new google.maps.Map(mapElement, {
        center: center,
        zoom: 15,
        disableDefaultUI: true,
        styles: [ { "stylers": [ { "hue": "#ff1a00" }, { "invert_lightness": true }, { "saturation": -100 }, { "lightness": 33 }, { "gamma": 0.5 } ] }, { "featureType": "water", "elementType": "geometry", "stylers": [ { "color": "#2D333C" } ] } ]
    });

    const marker = new google.maps.Marker({
        position: center,
        map: map,
        draggable: isDraggable
    });

    if (isDraggable) {
        marker.addListener('dragend', () => {
            const newPos = marker.getPosition();
            state.selectedPosition = { lat: newPos.lat(), lng: newPos.lng() };
        });
    }

    const searchInput = dom.modal.body.querySelector('#location-search-input');
    if (searchInput) {
        const autocomplete = new google.maps.places.Autocomplete(searchInput, {
            fields: ["geometry", "name"],
            types: ["geocode"],
        });
        
        autocomplete.bindTo("bounds", map);

        autocomplete.addListener('place_changed', () => {
            const place = autocomplete.getPlace();
            if (!place.geometry || !place.geometry.location) {
                console.log("No details available for input: '" + place.name + "'");
                return;
            }

            map.setCenter(place.geometry.location);
            map.setZoom(17);
            marker.setPosition(place.geometry.location);
            
            state.selectedPosition = {
                lat: place.geometry.location.lat(),
                lng: place.geometry.location.lng()
            };
        });
    }
}


function updateStepIndicator(currentStep) {
    const indicator = dom.modal.body.querySelector('#step-indicator');
    if (!indicator) return;
    const steps = ['Details', 'Location', 'Images', 'Verify'];
    indicator.innerHTML = ''; 
    steps.forEach((label, i) => {
        const stepNum = i + 1;
        const isActive = stepNum == currentStep;
        const isCompleted = stepNum < currentStep;
        const stepEl = document.createElement('div');
        stepEl.className = 'step relative flex flex-col items-center flex-1';
        if(isCompleted) stepEl.classList.add('completed');
        if(isActive) stepEl.classList.add('active');
        stepEl.innerHTML = `
            <div class="step-circle w-10 h-10 flex items-center justify-center rounded-full border-2 border-border-dark bg-card-dark relative z-10 font-bold">
                ${isCompleted ? '<i class="ph-bold ph-check"></i>' : stepNum}
            </div>
            <span class="step-label">${label}</span>
        `;
        indicator.appendChild(stepEl);
    });
}

function setChatContext(plotId) {
    const plot = state.plots.find(p => p.id == plotId);
    if (plot) {
        state.contextPlot = plot;
        openModal('AI Assistant', document.getElementById('chat-modal-template').innerHTML, { customClass: 'md:max-w-lg h-4/5' });
        dom.chat.context = document.getElementById('chat-context');
        dom.chat.box = document.getElementById('chat-box');
        dom.chat.starters = document.getElementById('chat-starters');
        dom.chat.input = document.getElementById('chat-input');
        dom.chat.sendBtn = document.getElementById('chat-send-btn');
        
        dom.chat.sendBtn.addEventListener('click', handleChatInput);
        dom.chat.input.addEventListener('keydown', e => { if (e.key === 'Enter') handleChatInput(); });
        dom.chat.starters.addEventListener('click', e => { if (e.target.matches('.chat-starter-btn')) { dom.chat.input.value = e.target.textContent; handleChatInput(); } });

        updateChatContextUI();
        displayChatMessage('ai', `Now discussing the plot in ${plot.location}. How can I help you with this specific property?`);
    }
}

function clearChatContext() {
    state.contextPlot = null;
    updateChatContextUI();
}

function updateChatContextUI() {
    if (dom.modal.body.contains(document.getElementById('chat-context'))) {
        dom.chat.context = document.getElementById('chat-context');
         if (state.contextPlot) {
            dom.chat.context.innerHTML = `
                <div class="flex items-center justify-between">
                    <span>Focusing on: <strong>${state.contextPlot.location}</strong></span>
                    <button id="clear-context-btn" class="text-xs hover:text-white">&times; Clear</button>
                </div>
            `;
            dom.chat.context.classList.remove('hidden');
            document.getElementById('clear-context-btn').addEventListener('click', clearChatContext);
        } else {
            dom.chat.context.classList.add('hidden');
            dom.chat.context.innerHTML = '';
        }
        updateChatStarters();
    }
}

async function openUserProfileModal() {
    const user = state.currentUser;
    if (!user) return;

    openModal('My Profile', document.getElementById('user-profile-modal-template').innerHTML, { customClass: 'md:max-w-2xl' });
    
    const { data: userData, error: userError } = await supabaseClient.from('users').select('role').eq('id', user.id).single();
    if(userError) console.error("Error fetching user role:", userError);

    const name = user.user_metadata?.full_name || user.email?.split('@')[0] || user.phone;
    const contact = user.email || user.phone;
    const pic = user.user_metadata?.avatar_url || `https://placehold.co/64x64/1e293b/e2e8f0?text=${name.charAt(0).toUpperCase()}`;
    const role = userData?.role || 'Not Set';


    dom.modal.body.querySelector('#profile-pic').src = pic;
    dom.modal.body.querySelector('#profile-name').textContent = name;
    dom.modal.body.querySelector('#profile-contact').textContent = contact;
    dom.modal.body.querySelector('#profile-role').textContent = role;

    const sellerSection = dom.modal.body.querySelector('#seller-profile-section');
    const buyerSection = dom.modal.body.querySelector('#buyer-profile-section');
    const sellerRoles = ['owner', 'agent', 'builder'];

    if (sellerRoles.includes(role)) {
        sellerSection.classList.remove('hidden');
        buyerSection.classList.add('hidden');
        const listingsContainer = dom.modal.body.querySelector('#my-listings-container');
        listingsContainer.innerHTML = '<div class="loader mx-auto"></div>';

        const { data: listings, error } = await supabaseClient.from('plots').select('*').eq('user_id', user.id);

        if (error) {
            listingsContainer.innerHTML = `<p class="text-red-400">Could not load your listings.</p>`;
            return;
        }

        if (listings.length === 0) {
            listingsContainer.innerHTML = `<p class="text-slate-400 text-center">You haven't listed any plots yet.</p>`;
            return;
        }

        const cardTemplate = document.getElementById('user-listing-card-template').innerHTML;
        listingsContainer.innerHTML = listings.map(plot => {
            const imageUrl = Array.isArray(plot.image_urls) && plot.image_urls.length > 0 ? plot.image_urls[0] : 'https://placehold.co/96x96';
            return cardTemplate
                .replaceAll('{id}', plot.id)
                .replace('{image_url}', imageUrl)
                .replace('{location}', plot.location)
                .replace('{city}', plot.city)
                .replace('{area_sqft}', plot.area_sqft)
                .replace('{price}', formatIndianCurrency(plot.price));
        }).join('');

        listingsContainer.addEventListener('click', async (e) => {
            if (e.target.closest('.delete-plot-btn')) {
                const plotId = e.target.closest('.delete-plot-btn').dataset.id;
                if (confirm('Are you sure you want to delete this listing? This cannot be undone.')) {
                    await deletePlot(plotId);
                }
            }
        });
    } else {
        buyerSection.classList.remove('hidden');
        sellerSection.classList.add('hidden');
    }
}

async function deletePlot(plotId) {
    try {
        const { data: plot, error: fetchError } = await supabaseClient
            .from('plots')
            .select('image_urls, aadhaar_url, sev_twelve_url')
            .eq('id', plotId)
            .single();

        if (fetchError) throw fetchError;
        
        const getPathFromUrl = (url) => {
            if (!url) return null;
            try {
                const urlObject = new URL(url);
                const pathParts = urlObject.pathname.split('/');
                const bucketIndex = pathParts.indexOf('public') + 1;
                return pathParts.slice(bucketIndex + 1).join('/');
            } catch (e) {
                console.error("Invalid URL for storage deletion:", url, e);
                return null;
            }
        };

        if (plot.image_urls && plot.image_urls.length > 0) {
            const filePaths = plot.image_urls.map(getPathFromUrl).filter(Boolean);
            if (filePaths.length > 0) {
                await supabaseClient.storage.from('plot-images').remove(filePaths);
            }
        }

        const docPaths = [getPathFromUrl(plot.aadhaar_url), getPathFromUrl(plot.sev_twelve_url)].filter(Boolean);
        if (docPaths.length > 0) {
             await supabaseClient.storage.from('plot-documents').remove(docPaths);
        }

        const { error: dbError } = await supabaseClient.from('plots').delete().eq('id', plotId);
        if (dbError) throw dbError;

        showFeedbackToast('Listing deleted successfully.', 'bg-green-600');
        
        openUserProfileModal();
        fetchPlotsByCity(state.activeCity);

    } catch (error) {
        console.error('Error deleting plot:', error);
        showFeedbackToast(`Error: ${error.message}`, 'bg-red-500');
    }
}

// --- Payment Integration ---
function handleSubscriptionPayment(planName, amount) {
    if (!state.currentUser) {
        showFeedbackToast('Please log in to purchase a subscription.', 'bg-red-500');
        openLoginModal();
        return;
    }
    openQrCodeModal(planName, amount);
}

function openQrCodeModal(planName, amount) {
    const template = document.getElementById('qr-code-modal-template').innerHTML
        .replace('{planName}', planName.charAt(0).toUpperCase() + planName.slice(1))
        .replace('{amount}', amount);
    
    openModal('Scan to Subscribe', template, { customClass: 'md:max-w-md' });

    // Show the correct QR code based on the selected plan
    const enterpriseQr = dom.modal.body.querySelector('#qr-code-enterprise');
    const proQr = dom.modal.body.querySelector('#qr-code-pro');

    if (planName === 'enterprise') {
        enterpriseQr.classList.remove('hidden');
    } else if (planName === 'pro') {
        proQr.classList.remove('hidden');
    }

    const verifyBtn = dom.modal.body.querySelector('#verify-payment-btn');
    const transactionIdInput = dom.modal.body.querySelector('#transaction-id');

    verifyBtn.addEventListener('click', () => {
        const transactionId = transactionIdInput.value.trim();
        if (transactionId.length < 12) {
            showFeedbackToast('Please enter a valid 12-digit transaction ID.', 'bg-red-500');
            return;
        }
        handleQrPaymentVerification(planName, transactionId);
    });
}

async function handleQrPaymentVerification(planName, transactionId) {
    // In a real application, you would have a backend that verifies this transactionId with your payment provider.
    // Here, we will simulate a successful verification.
    showFeedbackToast('Verifying payment... Please wait.', 'bg-blue-600');
    
    // Simulate network delay for verification
    await new Promise(resolve => setTimeout(resolve, 2000));

    await saveSubscription(planName, transactionId);
}

async function saveSubscription(planName, transactionId) {
    const user = state.currentUser;
    if (!user) return;

    const endDate = new Date();
    endDate.setDate(endDate.getDate() + 30);

    const { error } = await supabaseClient
      .from('subscriptions')
      .insert([
        { 
          user_id: user.id, 
          plan: planName, 
          status: 'active',
          razorpay_payment_id: transactionId, // Re-using this column for the transaction ID
          end_date: endDate.toISOString()
        }
      ]);

    if (error) {
        console.error("Error saving subscription:", error);
        showFeedbackToast(`Error: ${error.message}`, 'bg-red-500');
    } else {
        state.plan = planName;
        showFeedbackToast('Subscription successful!', 'bg-green-600');
        closeModal();
        updateAdRibbon();
    }
}
</script>
</body>
</html>
